/****************************************************************************************************************************
 
 제목 : 유동인구분석_CLUSTERING 결과테이블 생성
 일시 : 2018. 09. 11
 버전 : v02
 수정일시 : 2019. 03. 12
 수정사유: 간헐적인 대전시 데이터 오류 수정을 위한 인벤토리 참조 쿼리 이상(삭제 기지국 누적 처리되는 현상)
 수정내용: 인벤토리에 적재된 최종일자 데이터를 사용하도록 변경
 
****************************************************************************************************************************/
/* R에서 불러온 11_TEMP 데이터를 11_TEMP 인밴토리에 저장 */
INSERT OVERWRITE TABLE BDPL200.L2COT_DYNA_ANAL_CLUSTER_SU_11_INVENTORY_TEMP
PARTITION (
   P_BASIS_YYYY = YEAR(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_MM = MONTH(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_DD = DAY(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
       )
SELECT *
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_SU_11_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_DYNA_ANAL_CLUSTER_SU_11_INVENTORY_TEMP ;



INSERT OVERWRITE TABLE BDPL200.L2COT_DYNA_ANAL_CLUSTER_GGI_11_INVENTORY_TEMP
PARTITION (
   P_BASIS_YYYY = YEAR(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_MM = MONTH(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_DD = DAY(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
       )
SELECT *
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_GGI_11_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_DYNA_ANAL_CLUSTER_GGI_11_INVENTORY_TEMP ;


INSERT OVERWRITE TABLE BDPL200.L2COT_DYNA_ANAL_CLUSTER_ICN_11_INVENTORY_TEMP
PARTITION (
   P_BASIS_YYYY = YEAR(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_MM = MONTH(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_DD = DAY(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
       )
SELECT *
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_ICN_11_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_DYNA_ANAL_CLUSTER_ICN_11_INVENTORY_TEMP ;



INSERT OVERWRITE TABLE BDPL200.L2COT_DYNA_ANAL_CLUSTER_DG_11_INVENTORY_TEMP
PARTITION (
   P_BASIS_YYYY = YEAR(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_MM = MONTH(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_DD = DAY(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
       )
SELECT *
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_DG_11_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_DYNA_ANAL_CLUSTER_DG_11_INVENTORY_TEMP ;


INSERT OVERWRITE TABLE BDPL200.L2COT_DYNA_ANAL_CLUSTER_DJ_11_INVENTORY_TEMP
PARTITION (
   P_BASIS_YYYY = YEAR(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_MM = MONTH(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_DD = DAY(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
       )
SELECT *
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_DJ_11_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_DYNA_ANAL_CLUSTER_DJ_11_INVENTORY_TEMP ;


INSERT OVERWRITE TABLE BDPL200.L2COT_DYNA_ANAL_CLUSTER_GJ_11_INVENTORY_TEMP
PARTITION (
   P_BASIS_YYYY = YEAR(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_MM = MONTH(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_DD = DAY(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
       )
SELECT *
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_GJ_11_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_DYNA_ANAL_CLUSTER_GJ_11_INVENTORY_TEMP ;


INSERT OVERWRITE TABLE BDPL200.L2COT_DYNA_ANAL_CLUSTER_BSN_11_INVENTORY_TEMP
PARTITION (
   P_BASIS_YYYY = YEAR(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_MM = MONTH(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
  , P_BASIS_DD = DAY(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1))
       )
SELECT *
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_BSN_11_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_DYNA_ANAL_CLUSTER_BSN_11_INVENTORY_TEMP ;


/* 데이터가 있는지 확인하여 없으면 적재하는 쿼리 */
--DROP TABLE IF EXISTS BDPL200.L2COT_DYNA_ANAL_CLUSTER_TEMP;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_DYNA_ANAL_CLUSTER_TEMP;
--CREATE TABLE BDPL200.L2COT_DYNA_ANAL_CLUSTER_TEMP STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_DYNA_ANAL_CLUSTER_TEMP' AS
INSERT OVERWRITE TABLE BDPL200.L2COT_DYNA_ANAL_CLUSTER_TEMP
SELECT
  'SU' AS CITY_CD
 , CAST(GPNAME AS BIGINT) AS GPNAME
 , SEQ
 , LTE_CEL_ID
 , ESTB_ADDR
 , CCW_NM
 , TOWN_NM
 , LAT_CRDNT_ADDR
 , LOT_CRDNT_ADDR
 , MEANLAT
 , MEANLOT
 , CLUSTCVG
 , TOWN_MEAN_COST
 , CCW_MEAN_COST
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_SU_11_INVENTORY_TEMP
WHERE P_BASIS_YYYY = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),1,4) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_SU_11_INVENTORY_TEMP )
 AND P_BASIS_MM = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),5,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_SU_11_INVENTORY_TEMP )
 AND P_BASIS_DD = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),7,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_SU_11_INVENTORY_TEMP )
 AND (
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) )
  )
UNION ALL
SELECT
  'GGI' AS CITY_CD
 , CAST(GPNAME AS BIGINT) AS GPNAME
 , SEQ
 , LTE_CEL_ID
 , ESTB_ADDR
 , CCW_NM
 , TOWN_NM
 , LAT_CRDNT_ADDR
 , LOT_CRDNT_ADDR
 , MEANLAT
 , MEANLOT
 , CLUSTCVG
 , NULL AS TOWN_MEAN_COST
 , NULL AS CCW_MEAN_COST
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_GGI_11_INVENTORY_TEMP
WHERE P_BASIS_YYYY = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),1,4) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_GGI_11_INVENTORY_TEMP )
 AND P_BASIS_MM = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),5,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_GGI_11_INVENTORY_TEMP )
 AND P_BASIS_DD = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),7,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_GGI_11_INVENTORY_TEMP )
 AND (
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) )
  )
UNION ALL
SELECT
  'ICN' AS CITY_CD
 , CAST(GPNAME AS BIGINT) AS GPNAME
 , SEQ
 , LTE_CEL_ID
 , ESTB_ADDR
 , CCW_NM
 , TOWN_NM
 , LAT_CRDNT_ADDR
 , LOT_CRDNT_ADDR
 , MEANLAT
 , MEANLOT
 , CLUSTCVG
 , NULL AS TOWN_MEAN_COST
 , NULL AS CCW_MEAN_COST
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_ICN_11_INVENTORY_TEMP
WHERE P_BASIS_YYYY = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),1,4) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_ICN_11_INVENTORY_TEMP )
 AND P_BASIS_MM = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),5,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_ICN_11_INVENTORY_TEMP )
 AND P_BASIS_DD = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),7,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_ICN_11_INVENTORY_TEMP )
 AND (
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) )
  )
UNION ALL
SELECT
  'DG' AS CITY_CD
 , CAST(GPNAME AS BIGINT) AS GPNAME
 , SEQ
 , LTE_CEL_ID
 , ESTB_ADDR
 , CCW_NM
 , TOWN_NM
 , LAT_CRDNT_ADDR
 , LOT_CRDNT_ADDR
 , MEANLAT
 , MEANLOT
 , CLUSTCVG
 , NULL AS TOWN_MEAN_COST
 , NULL AS CCW_MEAN_COST
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_DG_11_INVENTORY_TEMP
WHERE P_BASIS_YYYY = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),1,4) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_DG_11_INVENTORY_TEMP )
 AND P_BASIS_MM = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),5,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_DG_11_INVENTORY_TEMP )
 AND P_BASIS_DD = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),7,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_DG_11_INVENTORY_TEMP )
 AND (
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) )
  )
UNION ALL
SELECT
  'DJ' AS CITY_CD
 , CAST(GPNAME AS BIGINT) AS GPNAME
 , SEQ
 , LTE_CEL_ID
 , ESTB_ADDR
 , CCW_NM
 , TOWN_NM
 , LAT_CRDNT_ADDR
 , LOT_CRDNT_ADDR
 , MEANLAT
 , MEANLOT
 , CLUSTCVG
 , NULL AS TOWN_MEAN_COST
 , NULL AS CCW_MEAN_COST
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_DJ_11_INVENTORY_TEMP
WHERE P_BASIS_YYYY = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),1,4) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_DJ_11_INVENTORY_TEMP )
 AND P_BASIS_MM = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),5,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_DJ_11_INVENTORY_TEMP )
 AND P_BASIS_DD = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),7,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_DJ_11_INVENTORY_TEMP )
 AND (
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) )
  )
UNION ALL
SELECT
  'GJ' AS CITY_CD
 , CAST(GPNAME AS BIGINT) AS GPNAME
 , SEQ
 , LTE_CEL_ID
 , ESTB_ADDR
 , CCW_NM
 , TOWN_NM
 , LAT_CRDNT_ADDR
 , LOT_CRDNT_ADDR
 , MEANLAT
 , MEANLOT
 , CLUSTCVG
 , NULL AS TOWN_MEAN_COST
 , NULL AS CCW_MEAN_COST
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_GJ_11_INVENTORY_TEMP
WHERE P_BASIS_YYYY = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),1,4) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_GJ_11_INVENTORY_TEMP )
 AND P_BASIS_MM = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),5,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_GJ_11_INVENTORY_TEMP )
 AND P_BASIS_DD = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),7,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_GJ_11_INVENTORY_TEMP )
 AND (
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) )
  )
UNION ALL
SELECT
  'BSN' AS CITY_CD
 , CAST(GPNAME AS BIGINT) AS GPNAME
 , SEQ
 , LTE_CEL_ID
 , ESTB_ADDR
 , CCW_NM
 , TOWN_NM
 , LAT_CRDNT_ADDR
 , LOT_CRDNT_ADDR
 , MEANLAT
 , MEANLOT
 , CLUSTCVG
 , NULL AS TOWN_MEAN_COST
 , NULL AS CCW_MEAN_COST
FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_BSN_11_INVENTORY_TEMP
WHERE P_BASIS_YYYY = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),1,4) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_BSN_11_INVENTORY_TEMP )
 AND P_BASIS_MM = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),5,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_BSN_11_INVENTORY_TEMP )
 AND P_BASIS_DD = ( SELECT CAST(SUBSTR(MAX(CAST(P_BASIS_YYYY*10000 + P_BASIS_MM*100 + P_BASIS_DD AS STRING)),7,2) AS INT) FROM BDPL200.L2COT_DYNA_ANAL_CLUSTER_BSN_11_INVENTORY_TEMP )
 AND (
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), 0)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)) ) OR
   ( P_BASIS_YYYY = YEAR(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) AND P_BASIS_MM = MONTH(ADD_MONTHS(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -2)) )
  )
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_DYNA_ANAL_CLUSTER_TEMP ;
