--1D
--1일 주기
/****************************************************************************************/
         --1일 원천 시작
        
/****************************************************************************************/


--1일전 데이터 원천에서 가지고옴

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP' AS 
SELECT    B.idkd_lcls_cd
    ,B.idkd_mcls_cd
    , B.IDKD_LCLS_CD_NM
    , B.IDKD_MCLS_CD_NM
    , A.STORE_ID
    , A.STORE_NM
    , A.ELST_SVC_NM
    , A.TRX_ID
    , A.STLM_AMT
    FROM BDPVIEW.L1DAT_ELST_STLM_TXN AS A
  INNER JOIN
  (
  SELECT  DISTINCT STORE_ID
    , IDKD_LCLS_CD_NM  --업종대분류코드명
    , IDKD_MCLS_CD_NM  --업종중분류코드명
    , idkd_lcls_cd
    , idkd_mcls_cd
    , TBL_DIVS_CD --우리PG거래사 여부 ='1'(O)
   FROM BDPL200.L2CET_COPB_HOST_SITE_IDFY_INFO
  ) AS B
  ON A.STORE_ID= B.STORE_ID
   WHERE 1=1
      AND A.P_BASIS_YYYY = YEAR(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1))
      AND A.P_BASIS_MM = MONTH(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1))
      AND A.P_BASIS_DD = DAY(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1))
      AND A.TRX_CNCL_YN = 0
      AND A.CUST_NO IS NOT NULL
      AND B.TBL_DIVS_CD='1'  -- 우리PG거래 상점들
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP ;


/****************************************************************************************/
         --전문교육 시작
/****************************************************************************************/

--------------------------------------------------------------------------------------------------------------
--전문교육 1달전
--------------------------------------------------------------------------------------------------------------

--전문교육 1개월전 데이터 원천에서 가지고 온것중에 구매 ID 있는것 중복제거
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='전문교육'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP ;



/*전문교육 원천(1달전)으로부터 LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_1_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='전문교육'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_1_TEMP ;

/* 전문교육 원천(1달전)으로부터 LIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_2_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SPECIAL_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='전문교육'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_2_TEMP ;

/* 전문교육 원천(1달전)으로부터  LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_3_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SPECIAL_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SPECIAL_LIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='전문교육'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_3_TEMP ;

/*  전문교육 LIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_4_TEMP' AS
SELECT DISTINCT *
FROM (  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_3_TEMP
 ) TMP
;



COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_4_TEMP ;

--NOTLIKE 시작
/* 전문교육 원천(1달전)으로부터  NOTLIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_1_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='전문교육'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_1_TEMP ;

/*전문교육 원천(1달전)으로부터 NOTLIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_2_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SPECIAL_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='전문교육'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_2_TEMP ;

/*전문교육 원천(1달전)으로부터NOT LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_3_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SPECIAL_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SPECIAL_NOTLIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='전문교육'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_3_TEMP ;

/*전문교육  NOTLIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_4_TEMP' AS
SELECT DISTINCT *
FROM ( SELECT IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm,  trx_id,  STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_3_TEMP
) TMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_4_TEMP ;

---- 전문교육(1달) 식별 <- LIKE, NOTLIKE 이용
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_2_TEMP' AS
SELECT
   A.IDKD_LCLS_CD
  , A.IDKD_MCLS_CD
  , A.idkd_lcls_cd_nm
  , A.idkd_mcls_cd_nm
  , A.store_nm
  , A.elst_svc_nm
  , A.trx_id
  , A.STLM_AMT
  , A.INCL_KWRD_NM AS prod_kwrd
 FROM ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , INCL_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_LIKE_4_TEMP ) AS A
left ANTI join ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , XCLN_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_NOTLIKE_4_TEMP ) AS B
--on A.MONTH_TRX_APRV_DT=B.MONTH_TRX_APRV_DT AND A.IDKD_LCLS_CD=B.IDKD_LCLS_CD AND A.IDKD_MCLS_CD=B.IDKD_MCLS_CD AND a.idkd_lcls_cd_nm=b.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm=B.idkd_mcls_cd_nm AND A.store_nm=B.store_nm AND A.elst_svc_nm=B.elst_svc_nm
ON A.TRX_ID=B.TRX_ID and a.INCL_KWRD_NM= b.XCLN_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_2_TEMP ;


----------------------------------------------------------------------------------
-- 식별 끝
----------------------------------------------------------------------------------

----------------------------------------------------------------------------------
-- 키워드 집계
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_3_TEMP' AS
SELECT
  IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , prod_kwrd
 , COUNT(prod_kwrd) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(prod_kwrd) >= 0 THEN SUM(STLM_AMT)/COUNT(prod_kwrd)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_2_TEMP
GROUP BY IDKD_LCLS_CD,IDKD_MCLS_CD,IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, prod_kwrd
;
COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_3_TEMP;
----------------------------------------------------------------------------------
-- 순위 산출 및 팔리지 않은 키워드 0 처리
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_4_TEMP' AS
SELECT
  D.IDKD_CD
 , C.IDKD_LCLS_CD
 , C.IDKD_MCLS_CD
 , C.IDKD_LCLS_CD_NM
 , C.IDKD_MCLS_CD_NM
 , C.KEYWORD_NM AS PROD_KWRD
 , C.CNT AS kwrd_cnt
 , RANK() OVER(PARTITION BY C.IDKD_LCLS_CD_NM , C.IDKD_MCLS_CD_NM ORDER BY C.CNT DESC) AS kwrd_rank
 , C.PROD_SUM_AMT
 , C.PROD_MAX_AMT
 , C.PROD_AVG_AMT
FROM ( 
  SELECT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.KEYWORD_NM
   , COALESCE(B.CNT, 0) AS CNT
   , COALESCE(B.PROD_SUM_AMT, 0) AS PROD_SUM_AMT
   , COALESCE(B.PROD_MAX_AMT, 0) AS PROD_MAX_AMT
   , COALESCE(B.PROD_AVG_AMT, 0) AS PROD_AVG_AMT
  FROM (SELECT DISTINCT KEYWORD_NM
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_MCLS_CD_NM
      , IDKD_LCLS_CD_NM
     FROM  (
     SELECT  IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , INCL_KWRD_NM AS KEYWORD_NM
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '교육'
     AND IDKD_MCLS_CD_NM = '전문교육'
     ) AS A1
     ) AS A
  LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_3_TEMP AS B
  ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.KEYWORD_NM = B.PROD_KWRD
  ) AS C
LEFT JOIN
(SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체') AS D
ON C.IDKD_LCLS_CD_NM = D.IDKD_LCLS_CD_NM AND C.IDKD_MCLS_CD_NM = D.IDKD_MCLS_CD_NM
--AND C.IDKD_LCLS_CD=D.IDKD_LCLS_CD AND C.IDKD_MCLS_CD=D.IDKD_MCLS_CD
  ;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_4_TEMP; 
---------------------------------------------------------------------------------
-- 점유율 구하기
---------------------------------------------------------------------------------- 
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_5_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_5_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_5_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_5_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.kwrd_rank-A.kwrd_rank) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_4_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
;


COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_5_TEMP;

/****************************************************************************************/
         -- 전문교육 끝
/****************************************************************************************/

/****************************************************************************************/
         --학과교육 시작
/****************************************************************************************/

--------------------------------------------------------------------------------------------------------------
--학과교육 1달전
--------------------------------------------------------------------------------------------------------------

--학과교육 1개월전 데이터 원천에서 가지고 온것중에 구매 ID 있는것 중복제거
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='학과교육'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP ;



/*학과교육 원천(1달전)으로부터 LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_1_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='학과교육'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_1_TEMP ;

/* 학과교육 원천(1달전)으로부터 LIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_2_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SCHOOL_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='학과교육'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_2_TEMP ;

/* 학과교육 원천(1달전)으로부터  LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_3_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SCHOOL_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SCHOOL_LIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='학과교육'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_3_TEMP ;

/*  학과교육 LIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_4_TEMP' AS
SELECT DISTINCT *
FROM (  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_3_TEMP
 ) TMP
;



COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_4_TEMP ;

--NOTLIKE 시작
/* 학과교육 원천(1달전)으로부터  NOTLIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_1_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='학과교육'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_1_TEMP ;

/*학과교육 원천(1달전)으로부터 NOTLIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_2_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SCHOOL_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='학과교육'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_2_TEMP ;

/*학과교육 원천(1달전)으로부터NOT LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_3_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SCHOOL_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_SCHOOL_NOTLIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='학과교육'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_3_TEMP ;

/*학과교육  NOTLIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_4_TEMP' AS
SELECT DISTINCT *
FROM ( SELECT IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm,  trx_id,  STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_3_TEMP
) TMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_4_TEMP ;

---- 학과교육(1달) 식별 <- LIKE, NOTLIKE 이용
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_2_TEMP' AS
SELECT
   A.IDKD_LCLS_CD
  , A.IDKD_MCLS_CD
  , A.idkd_lcls_cd_nm
  , A.idkd_mcls_cd_nm
  , A.store_nm
  , A.elst_svc_nm
  , A.trx_id
  , A.STLM_AMT
  , A.INCL_KWRD_NM AS prod_kwrd
 FROM ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , INCL_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_LIKE_4_TEMP ) AS A
left ANTI join ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , XCLN_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_NOTLIKE_4_TEMP ) AS B
--on A.MONTH_TRX_APRV_DT=B.MONTH_TRX_APRV_DT AND A.IDKD_LCLS_CD=B.IDKD_LCLS_CD AND A.IDKD_MCLS_CD=B.IDKD_MCLS_CD AND a.idkd_lcls_cd_nm=b.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm=B.idkd_mcls_cd_nm AND A.store_nm=B.store_nm AND A.elst_svc_nm=B.elst_svc_nm
ON A.TRX_ID=B.TRX_ID and a.INCL_KWRD_NM= b.XCLN_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_2_TEMP ;


----------------------------------------------------------------------------------
-- 식별 끝
----------------------------------------------------------------------------------

----------------------------------------------------------------------------------
-- 키워드 집계
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_3_TEMP' AS
SELECT
  IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , prod_kwrd
 , COUNT(prod_kwrd) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(prod_kwrd) >= 0 THEN SUM(STLM_AMT)/COUNT(prod_kwrd)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_2_TEMP
GROUP BY IDKD_LCLS_CD,IDKD_MCLS_CD,IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, prod_kwrd
;
COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_3_TEMP;
----------------------------------------------------------------------------------
-- 순위 산출 및 팔리지 않은 키워드 0 처리
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_4_TEMP' AS
SELECT
  D.IDKD_CD
 , C.IDKD_LCLS_CD
 , C.IDKD_MCLS_CD
 , C.IDKD_LCLS_CD_NM
 , C.IDKD_MCLS_CD_NM
 , C.KEYWORD_NM AS PROD_KWRD
 , C.CNT AS kwrd_cnt
 , RANK() OVER(PARTITION BY C.IDKD_LCLS_CD_NM , C.IDKD_MCLS_CD_NM ORDER BY C.CNT DESC) AS kwrd_rank
 , C.PROD_SUM_AMT
 , C.PROD_MAX_AMT
 , C.PROD_AVG_AMT
FROM ( 
  SELECT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.KEYWORD_NM
   , COALESCE(B.CNT, 0) AS CNT
   , COALESCE(B.PROD_SUM_AMT, 0) AS PROD_SUM_AMT
   , COALESCE(B.PROD_MAX_AMT, 0) AS PROD_MAX_AMT
   , COALESCE(B.PROD_AVG_AMT, 0) AS PROD_AVG_AMT
  FROM (SELECT DISTINCT KEYWORD_NM
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_MCLS_CD_NM
      , IDKD_LCLS_CD_NM
     FROM  (
     SELECT  IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , INCL_KWRD_NM AS KEYWORD_NM
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '교육'
     AND IDKD_MCLS_CD_NM = '학과교육'
     ) AS A1
     ) AS A
  LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_3_TEMP AS B
  ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.KEYWORD_NM = B.PROD_KWRD
  ) AS C
LEFT JOIN
(SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체') AS D
ON C.IDKD_LCLS_CD_NM = D.IDKD_LCLS_CD_NM AND C.IDKD_MCLS_CD_NM = D.IDKD_MCLS_CD_NM
--AND C.IDKD_LCLS_CD=D.IDKD_LCLS_CD AND C.IDKD_MCLS_CD=D.IDKD_MCLS_CD
  ;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_4_TEMP; 
---------------------------------------------------------------------------------
-- 점유율 구하기
---------------------------------------------------------------------------------- 
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_5_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_5_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_5_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_5_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.kwrd_rank-A.kwrd_rank) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_4_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_5_TEMP;
/****************************************************************************************/
         -- 학과교육 끝
/****************************************************************************************/

/****************************************************************************************/
         --어학교육 시작
/****************************************************************************************/

--------------------------------------------------------------------------------------------------------------
--어학교육 1달전
--------------------------------------------------------------------------------------------------------------

--어학교육 1개월전 데이터 원천에서 가지고 온것중에 구매 ID 있는것 중복제거
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='어학교육'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP ;



/*어학교육 원천(1달전)으로부터 LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_1_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='어학교육'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_1_TEMP ;

/* 어학교육 원천(1달전)으로부터 LIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_2_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_LANG_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='어학교육'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_2_TEMP ;

/* 어학교육 원천(1달전)으로부터  LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_3_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_LANG_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_LANG_LIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='어학교육'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_3_TEMP ;

/*  어학교육 LIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_4_TEMP' AS
SELECT DISTINCT *
FROM (  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_3_TEMP
 ) TMP
;



COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_4_TEMP ;

--NOTLIKE 시작
/* 어학교육 원천(1달전)으로부터  NOTLIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_1_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='어학교육'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_1_TEMP ;

/*어학교육 원천(1달전)으로부터 NOTLIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_2_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_LANG_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='어학교육'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_2_TEMP ;

/*어학교육 원천(1달전)으로부터NOT LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_3_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_LANG_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_EDU_LANG_NOTLIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='어학교육'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_3_TEMP ;

/*어학교육  NOTLIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_4_TEMP' AS
SELECT DISTINCT *
FROM ( SELECT IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm,  trx_id,  STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_3_TEMP
) TMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_4_TEMP ;

---- 어학교육(1달) 식별 <- LIKE, NOTLIKE 이용
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_2_TEMP' AS
SELECT
   A.IDKD_LCLS_CD
  , A.IDKD_MCLS_CD
  , A.idkd_lcls_cd_nm
  , A.idkd_mcls_cd_nm
  , A.store_nm
  , A.elst_svc_nm
  , A.trx_id
  , A.STLM_AMT
  , A.INCL_KWRD_NM AS prod_kwrd
 FROM ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , INCL_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_LIKE_4_TEMP ) AS A
left ANTI join ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , XCLN_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_NOTLIKE_4_TEMP ) AS B
--on A.MONTH_TRX_APRV_DT=B.MONTH_TRX_APRV_DT AND A.IDKD_LCLS_CD=B.IDKD_LCLS_CD AND A.IDKD_MCLS_CD=B.IDKD_MCLS_CD AND a.idkd_lcls_cd_nm=b.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm=B.idkd_mcls_cd_nm AND A.store_nm=B.store_nm AND A.elst_svc_nm=B.elst_svc_nm
ON A.TRX_ID=B.TRX_ID and a.INCL_KWRD_NM= b.XCLN_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_2_TEMP ;


----------------------------------------------------------------------------------
-- 식별 끝
----------------------------------------------------------------------------------

----------------------------------------------------------------------------------
-- 키워드 집계
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_3_TEMP' AS
SELECT
  IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , prod_kwrd
 , COUNT(prod_kwrd) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(prod_kwrd) >= 0 THEN SUM(STLM_AMT)/COUNT(prod_kwrd)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_2_TEMP
GROUP BY IDKD_LCLS_CD,IDKD_MCLS_CD,IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, prod_kwrd
;
COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_3_TEMP;
----------------------------------------------------------------------------------
-- 순위 산출 및 팔리지 않은 키워드 0 처리
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_4_TEMP' AS
SELECT
  D.IDKD_CD
 , C.IDKD_LCLS_CD
 , C.IDKD_MCLS_CD
 , C.IDKD_LCLS_CD_NM
 , C.IDKD_MCLS_CD_NM
 , C.KEYWORD_NM AS PROD_KWRD
 , C.CNT AS kwrd_cnt
 , RANK() OVER(PARTITION BY C.IDKD_LCLS_CD_NM , C.IDKD_MCLS_CD_NM ORDER BY C.CNT DESC) AS kwrd_rank
 , C.PROD_SUM_AMT
 , C.PROD_MAX_AMT
 , C.PROD_AVG_AMT
FROM ( 
  SELECT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.KEYWORD_NM
   , COALESCE(B.CNT, 0) AS CNT
   , COALESCE(B.PROD_SUM_AMT, 0) AS PROD_SUM_AMT
   , COALESCE(B.PROD_MAX_AMT, 0) AS PROD_MAX_AMT
   , COALESCE(B.PROD_AVG_AMT, 0) AS PROD_AVG_AMT
  FROM (SELECT DISTINCT KEYWORD_NM
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_MCLS_CD_NM
      , IDKD_LCLS_CD_NM
     FROM  (
     SELECT  IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , INCL_KWRD_NM AS KEYWORD_NM
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '교육'
     AND IDKD_MCLS_CD_NM = '어학교육'
     ) AS A1
     ) AS A
  LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_3_TEMP AS B
  ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.KEYWORD_NM = B.PROD_KWRD
  ) AS C
LEFT JOIN
(SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체') AS D
ON C.IDKD_LCLS_CD_NM = D.IDKD_LCLS_CD_NM AND C.IDKD_MCLS_CD_NM = D.IDKD_MCLS_CD_NM
--AND C.IDKD_LCLS_CD=D.IDKD_LCLS_CD AND C.IDKD_MCLS_CD=D.IDKD_MCLS_CD
  ;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_4_TEMP; 
---------------------------------------------------------------------------------
-- 점유율 구하기
---------------------------------------------------------------------------------- 
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_5_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_5_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_5_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_5_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.kwrd_rank-A.kwrd_rank) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_4_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
; 

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_5_TEMP;
/****************************************************************************************/
         -- 어학교육 끝
/****************************************************************************************/



/****************************************************************************************/
         --조리식품 시작
/****************************************************************************************/

--------------------------------------------------------------------------------------------------------------
--조리식품 1달전
--------------------------------------------------------------------------------------------------------------

--조리식품 1개월전 데이터 원천에서 가지고 온것중에 구매 ID 있는것 중복제거
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='조리식품'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP ;



/*조리식품 원천(1달전)으로부터 LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_1_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='조리식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_1_TEMP ;

/* 조리식품 원천(1달전)으로부터 LIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_2_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_COOK_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='조리식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_2_TEMP ;

/* 조리식품 원천(1달전)으로부터  LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_3_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_COOK_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_COOK_LIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='조리식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_3_TEMP ;

/*  조리식품 LIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_4_TEMP' AS
SELECT DISTINCT *
FROM (  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_3_TEMP
 ) TMP
;



COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_4_TEMP ;

--NOTLIKE 시작
/* 조리식품 원천(1달전)으로부터  NOTLIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_1_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='조리식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_1_TEMP ;

/*조리식품 원천(1달전)으로부터 NOTLIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_2_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_COOK_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='조리식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_2_TEMP ;

/*조리식품 원천(1달전)으로부터NOT LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_3_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_COOK_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_COOK_NOTLIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='조리식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_3_TEMP ;

/*조리식품  NOTLIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_4_TEMP' AS
SELECT DISTINCT *
FROM ( SELECT IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm,  trx_id,  STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_3_TEMP
) TMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_4_TEMP ;

---- 조리식품(1달) 식별 <- LIKE, NOTLIKE 이용
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_2_TEMP' AS
SELECT
   A.IDKD_LCLS_CD
  , A.IDKD_MCLS_CD
  , A.idkd_lcls_cd_nm
  , A.idkd_mcls_cd_nm
  , A.store_nm
  , A.elst_svc_nm
  , A.trx_id
  , A.STLM_AMT
  , A.INCL_KWRD_NM AS prod_kwrd
 FROM ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , INCL_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_LIKE_4_TEMP ) AS A
left ANTI join ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , XCLN_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_NOTLIKE_4_TEMP ) AS B
--on A.MONTH_TRX_APRV_DT=B.MONTH_TRX_APRV_DT AND A.IDKD_LCLS_CD=B.IDKD_LCLS_CD AND A.IDKD_MCLS_CD=B.IDKD_MCLS_CD AND a.idkd_lcls_cd_nm=b.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm=B.idkd_mcls_cd_nm AND A.store_nm=B.store_nm AND A.elst_svc_nm=B.elst_svc_nm
ON A.TRX_ID=B.TRX_ID and a.INCL_KWRD_NM= b.XCLN_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_2_TEMP ;


----------------------------------------------------------------------------------
-- 식별 끝
----------------------------------------------------------------------------------

----------------------------------------------------------------------------------
-- 키워드 집계
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_3_TEMP' AS
SELECT
  IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , prod_kwrd
 , COUNT(prod_kwrd) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(prod_kwrd) >= 0 THEN SUM(STLM_AMT)/COUNT(prod_kwrd)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_2_TEMP
GROUP BY IDKD_LCLS_CD,IDKD_MCLS_CD,IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, prod_kwrd
;
COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_3_TEMP;
----------------------------------------------------------------------------------
-- 순위 산출 및 팔리지 않은 키워드 0 처리
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_4_TEMP' AS
SELECT
  D.IDKD_CD
 , C.IDKD_LCLS_CD
 , C.IDKD_MCLS_CD
 , C.IDKD_LCLS_CD_NM
 , C.IDKD_MCLS_CD_NM
 , C.KEYWORD_NM AS PROD_KWRD
 , C.CNT AS kwrd_cnt
 , RANK() OVER(PARTITION BY C.IDKD_LCLS_CD_NM , C.IDKD_MCLS_CD_NM ORDER BY C.CNT DESC) AS kwrd_rank
 , C.PROD_SUM_AMT
 , C.PROD_MAX_AMT
 , C.PROD_AVG_AMT
FROM ( 
  SELECT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.KEYWORD_NM
   , COALESCE(B.CNT, 0) AS CNT
   , COALESCE(B.PROD_SUM_AMT, 0) AS PROD_SUM_AMT
   , COALESCE(B.PROD_MAX_AMT, 0) AS PROD_MAX_AMT
   , COALESCE(B.PROD_AVG_AMT, 0) AS PROD_AVG_AMT
  FROM (SELECT DISTINCT KEYWORD_NM
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_MCLS_CD_NM
      , IDKD_LCLS_CD_NM
     FROM  (
     SELECT  IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , INCL_KWRD_NM AS KEYWORD_NM
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '식품'
     AND IDKD_MCLS_CD_NM = '조리식품'
     ) AS A1
     ) AS A
  LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_3_TEMP AS B
  ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.KEYWORD_NM = B.PROD_KWRD
  ) AS C
LEFT JOIN
(SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체') AS D
ON C.IDKD_LCLS_CD_NM = D.IDKD_LCLS_CD_NM AND C.IDKD_MCLS_CD_NM = D.IDKD_MCLS_CD_NM
--AND C.IDKD_LCLS_CD=D.IDKD_LCLS_CD AND C.IDKD_MCLS_CD=D.IDKD_MCLS_CD
  ;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_4_TEMP; 
---------------------------------------------------------------------------------
-- 점유율 구하기
---------------------------------------------------------------------------------- 
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_5_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_5_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_5_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_5_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.kwrd_rank-A.kwrd_rank) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_4_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_5_TEMP;
/****************************************************************************************/
         -- 조리식품 끝
/****************************************************************************************/

/****************************************************************************************/
         --종합식품 시작
/****************************************************************************************/

--------------------------------------------------------------------------------------------------------------
--종합식품 1달전
--------------------------------------------------------------------------------------------------------------

--종합식품 1개월전 데이터 원천에서 가지고 온것중에 구매 ID 있는것 중복제거
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='종합식품'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP ;



/*종합식품 원천(1달전)으로부터 LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_1_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='종합식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_1_TEMP ;

/* 종합식품 원천(1달전)으로부터 LIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_2_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_TOTAL_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='종합식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_2_TEMP ;

/* 종합식품 원천(1달전)으로부터  LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_3_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_TOTAL_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_TOTAL_LIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='종합식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_3_TEMP ;

/*  종합식품 LIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_4_TEMP' AS
SELECT DISTINCT *
FROM (  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_3_TEMP
 ) TMP
;



COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_4_TEMP ;

--NOTLIKE 시작
/* 종합식품 원천(1달전)으로부터  NOTLIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_1_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='종합식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_1_TEMP ;

/*종합식품 원천(1달전)으로부터 NOTLIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_2_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_TOTAL_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='종합식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_2_TEMP ;

/*종합식품 원천(1달전)으로부터NOT LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_3_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_TOTAL_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_TOTAL_NOTLIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='종합식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_3_TEMP ;

/*종합식품  NOTLIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_4_TEMP' AS
SELECT DISTINCT *
FROM ( SELECT IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm,  trx_id,  STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_3_TEMP
) TMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_4_TEMP ;

---- 종합식품(1달) 식별 <- LIKE, NOTLIKE 이용
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_2_TEMP' AS
SELECT
   A.IDKD_LCLS_CD
  , A.IDKD_MCLS_CD
  , A.idkd_lcls_cd_nm
  , A.idkd_mcls_cd_nm
  , A.store_nm
  , A.elst_svc_nm
  , A.trx_id
  , A.STLM_AMT
  , A.INCL_KWRD_NM AS prod_kwrd
 FROM ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , INCL_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_LIKE_4_TEMP ) AS A
left ANTI join ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , XCLN_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_NOTLIKE_4_TEMP ) AS B
--on A.MONTH_TRX_APRV_DT=B.MONTH_TRX_APRV_DT AND A.IDKD_LCLS_CD=B.IDKD_LCLS_CD AND A.IDKD_MCLS_CD=B.IDKD_MCLS_CD AND a.idkd_lcls_cd_nm=b.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm=B.idkd_mcls_cd_nm AND A.store_nm=B.store_nm AND A.elst_svc_nm=B.elst_svc_nm
ON A.TRX_ID=B.TRX_ID and a.INCL_KWRD_NM= b.XCLN_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_2_TEMP ;


----------------------------------------------------------------------------------
-- 식별 끝
----------------------------------------------------------------------------------

----------------------------------------------------------------------------------
-- 키워드 집계
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_3_TEMP' AS
SELECT
  IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , prod_kwrd
 , COUNT(prod_kwrd) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(prod_kwrd) >= 0 THEN SUM(STLM_AMT)/COUNT(prod_kwrd)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_2_TEMP
GROUP BY IDKD_LCLS_CD,IDKD_MCLS_CD,IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, prod_kwrd
;
COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_3_TEMP;
----------------------------------------------------------------------------------
-- 순위 산출 및 팔리지 않은 키워드 0 처리
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_4_TEMP' AS
SELECT
  D.IDKD_CD
 , C.IDKD_LCLS_CD
 , C.IDKD_MCLS_CD
 , C.IDKD_LCLS_CD_NM
 , C.IDKD_MCLS_CD_NM
 , C.KEYWORD_NM AS PROD_KWRD
 , C.CNT AS kwrd_cnt
 , RANK() OVER(PARTITION BY C.IDKD_LCLS_CD_NM , C.IDKD_MCLS_CD_NM ORDER BY C.CNT DESC) AS kwrd_rank
 , C.PROD_SUM_AMT
 , C.PROD_MAX_AMT
 , C.PROD_AVG_AMT
FROM ( 
  SELECT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.KEYWORD_NM
   , COALESCE(B.CNT, 0) AS CNT
   , COALESCE(B.PROD_SUM_AMT, 0) AS PROD_SUM_AMT
   , COALESCE(B.PROD_MAX_AMT, 0) AS PROD_MAX_AMT
   , COALESCE(B.PROD_AVG_AMT, 0) AS PROD_AVG_AMT
  FROM (SELECT DISTINCT KEYWORD_NM
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_MCLS_CD_NM
      , IDKD_LCLS_CD_NM
     FROM  (
     SELECT  IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , INCL_KWRD_NM AS KEYWORD_NM
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '식품'
     AND IDKD_MCLS_CD_NM = '종합식품'
     ) AS A1
     ) AS A
  LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_3_TEMP AS B
  ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.KEYWORD_NM = B.PROD_KWRD
  ) AS C
LEFT JOIN
(SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체') AS D
ON C.IDKD_LCLS_CD_NM = D.IDKD_LCLS_CD_NM AND C.IDKD_MCLS_CD_NM = D.IDKD_MCLS_CD_NM
--AND C.IDKD_LCLS_CD=D.IDKD_LCLS_CD AND C.IDKD_MCLS_CD=D.IDKD_MCLS_CD
  ;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_4_TEMP; 
---------------------------------------------------------------------------------
-- 점유율 구하기
---------------------------------------------------------------------------------- 
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_5_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_5_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_5_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_5_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.kwrd_rank-A.kwrd_rank) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_4_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_5_TEMP;
/****************************************************************************************/
         -- 종합식품 끝
/****************************************************************************************/
/****************************************************************************************/
         --건강식품 시작
/****************************************************************************************/

--------------------------------------------------------------------------------------------------------------
--건강식품 1달전
--------------------------------------------------------------------------------------------------------------

--건강식품 1개월전 데이터 원천에서 가지고 온것중에 구매 ID 있는것 중복제거
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='건강식품'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP ;



/*건강식품 원천(1달전)으로부터 LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_1_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='건강식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_1_TEMP ;

/* 건강식품 원천(1달전)으로부터 LIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_2_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_HLTH_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='건강식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_2_TEMP ;

/* 건강식품 원천(1달전)으로부터  LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_3_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_HLTH_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_HLTH_LIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='건강식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_3_TEMP ;

/*  건강식품 LIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_4_TEMP' AS
SELECT DISTINCT *
FROM (  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_3_TEMP
 ) TMP
;



COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_4_TEMP ;

--NOTLIKE 시작
/* 건강식품 원천(1달전)으로부터  NOTLIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_1_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='건강식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_1_TEMP ;

/*건강식품 원천(1달전)으로부터 NOTLIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_2_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_HLTH_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='건강식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_2_TEMP ;

/*건강식품 원천(1달전)으로부터NOT LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_3_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_HLTH_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_HLTH_NOTLIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='건강식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_3_TEMP ;

/*건강식품  NOTLIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_4_TEMP' AS
SELECT DISTINCT *
FROM ( SELECT IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm,  trx_id,  STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_3_TEMP
) TMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_4_TEMP ;

---- 건강식품(1달) 식별 <- LIKE, NOTLIKE 이용
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_2_TEMP' AS
SELECT
   A.IDKD_LCLS_CD
  , A.IDKD_MCLS_CD
  , A.idkd_lcls_cd_nm
  , A.idkd_mcls_cd_nm
  , A.store_nm
  , A.elst_svc_nm
  , A.trx_id
  , A.STLM_AMT
  , A.INCL_KWRD_NM AS prod_kwrd
 FROM ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , INCL_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_LIKE_4_TEMP ) AS A
left ANTI join ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , XCLN_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_NOTLIKE_4_TEMP ) AS B
--on A.MONTH_TRX_APRV_DT=B.MONTH_TRX_APRV_DT AND A.IDKD_LCLS_CD=B.IDKD_LCLS_CD AND A.IDKD_MCLS_CD=B.IDKD_MCLS_CD AND a.idkd_lcls_cd_nm=b.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm=B.idkd_mcls_cd_nm AND A.store_nm=B.store_nm AND A.elst_svc_nm=B.elst_svc_nm
ON A.TRX_ID=B.TRX_ID and a.INCL_KWRD_NM= b.XCLN_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_2_TEMP ;


----------------------------------------------------------------------------------
-- 식별 끝
----------------------------------------------------------------------------------

----------------------------------------------------------------------------------
-- 키워드 집계
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_3_TEMP' AS
SELECT
  IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , prod_kwrd
 , COUNT(prod_kwrd) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(prod_kwrd) >= 0 THEN SUM(STLM_AMT)/COUNT(prod_kwrd)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_2_TEMP
GROUP BY IDKD_LCLS_CD,IDKD_MCLS_CD,IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, prod_kwrd
;
COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_3_TEMP;
----------------------------------------------------------------------------------
-- 순위 산출 및 팔리지 않은 키워드 0 처리
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_4_TEMP' AS
SELECT
  D.IDKD_CD
 , C.IDKD_LCLS_CD
 , C.IDKD_MCLS_CD
 , C.IDKD_LCLS_CD_NM
 , C.IDKD_MCLS_CD_NM
 , C.KEYWORD_NM AS PROD_KWRD
 , C.CNT AS kwrd_cnt
 , RANK() OVER(PARTITION BY C.IDKD_LCLS_CD_NM , C.IDKD_MCLS_CD_NM ORDER BY C.CNT DESC) AS kwrd_rank
 , C.PROD_SUM_AMT
 , C.PROD_MAX_AMT
 , C.PROD_AVG_AMT
FROM ( 
  SELECT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.KEYWORD_NM
   , COALESCE(B.CNT, 0) AS CNT
   , COALESCE(B.PROD_SUM_AMT, 0) AS PROD_SUM_AMT
   , COALESCE(B.PROD_MAX_AMT, 0) AS PROD_MAX_AMT
   , COALESCE(B.PROD_AVG_AMT, 0) AS PROD_AVG_AMT
  FROM (SELECT DISTINCT KEYWORD_NM
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_MCLS_CD_NM
      , IDKD_LCLS_CD_NM
     FROM  (
     SELECT  IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , INCL_KWRD_NM AS KEYWORD_NM
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '식품'
     AND IDKD_MCLS_CD_NM = '건강식품'
     ) AS A1
     ) AS A
  LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_3_TEMP AS B
  ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.KEYWORD_NM = B.PROD_KWRD
  ) AS C
LEFT JOIN
(SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체') AS D
ON C.IDKD_LCLS_CD_NM = D.IDKD_LCLS_CD_NM AND C.IDKD_MCLS_CD_NM = D.IDKD_MCLS_CD_NM
--AND C.IDKD_LCLS_CD=D.IDKD_LCLS_CD AND C.IDKD_MCLS_CD=D.IDKD_MCLS_CD
  ;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_4_TEMP; 
---------------------------------------------------------------------------------
-- 점유율 구하기
---------------------------------------------------------------------------------- 
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_5_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_5_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_5_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_5_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.kwrd_rank-A.kwrd_rank) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_4_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_5_TEMP;
/****************************************************************************************/
         -- 건강식품 끝
/****************************************************************************************/

--간식가공부터 검증 시작

/****************************************************************************************/
         --간식/가공식품 시작
/****************************************************************************************/

--------------------------------------------------------------------------------------------------------------
--간식/가공식품 1달전
--------------------------------------------------------------------------------------------------------------

--간식/가공식품 1개월전 데이터 원천에서 가지고 온것중에 구매 ID 있는것 중복제거
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='간식/가공식품'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP ;




/*간식/가공식품 원천(1달전)으로부터 LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_1_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='간식/가공식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_1_TEMP ;

/* 간식/가공식품 원천(1달전)으로부터 LIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_2_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_SNACK_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='간식/가공식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_2_TEMP ;

/* 간식/가공식품 원천(1달전)으로부터  LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_3_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_SNACK_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_SNACK_LIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='간식/가공식품'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_3_TEMP ;

/*  간식/가공식품 LIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_4_TEMP' AS
SELECT DISTINCT *
FROM (  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_3_TEMP
 ) TMP
;



COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_4_TEMP ;

--NOTLIKE 시작
/* 간식/가공식품 원천(1달전)으로부터  NOTLIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_1_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='간식/가공식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_1_TEMP ;

/*간식/가공식품 원천(1달전)으로부터 NOTLIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_2_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_SNACK_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='간식/가공식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_2_TEMP ;

/*간식/가공식품 원천(1달전)으로부터NOT LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_3_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_SNACK_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_SNACK_NOTLIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='간식/가공식품'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_3_TEMP ;

/*간식/가공식품  NOTLIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_4_TEMP' AS
SELECT DISTINCT *
FROM ( SELECT IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm,  trx_id,  STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_3_TEMP
) TMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_4_TEMP ;

---- 간식/가공식품(1달) 식별 <- LIKE, NOTLIKE 이용
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_2_TEMP' AS
SELECT
   A.IDKD_LCLS_CD
  , A.IDKD_MCLS_CD
  , A.idkd_lcls_cd_nm
  , A.idkd_mcls_cd_nm
  , A.store_nm
  , A.elst_svc_nm
  , A.trx_id
  , A.STLM_AMT
  , A.INCL_KWRD_NM AS prod_kwrd
 FROM ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , INCL_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_LIKE_4_TEMP ) AS A
left ANTI join ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , XCLN_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_NOTLIKE_4_TEMP ) AS B
--on A.MONTH_TRX_APRV_DT=B.MONTH_TRX_APRV_DT AND A.IDKD_LCLS_CD=B.IDKD_LCLS_CD AND A.IDKD_MCLS_CD=B.IDKD_MCLS_CD AND a.idkd_lcls_cd_nm=b.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm=B.idkd_mcls_cd_nm AND A.store_nm=B.store_nm AND A.elst_svc_nm=B.elst_svc_nm
ON A.TRX_ID=B.TRX_ID and a.INCL_KWRD_NM= b.XCLN_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_2_TEMP ;


----------------------------------------------------------------------------------
-- 식별 끝
----------------------------------------------------------------------------------

----------------------------------------------------------------------------------
-- 키워드 집계
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_3_TEMP' AS
SELECT
  IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , prod_kwrd
 , COUNT(prod_kwrd) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(prod_kwrd) >= 0 THEN SUM(STLM_AMT)/COUNT(prod_kwrd)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_2_TEMP
GROUP BY IDKD_LCLS_CD,IDKD_MCLS_CD,IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, prod_kwrd
;
COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_3_TEMP;
----------------------------------------------------------------------------------
-- 순위 산출 및 팔리지 않은 키워드 0 처리
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_4_TEMP' AS
SELECT
  D.IDKD_CD
 , C.IDKD_LCLS_CD
 , C.IDKD_MCLS_CD
 , C.IDKD_LCLS_CD_NM
 , C.IDKD_MCLS_CD_NM
 , C.KEYWORD_NM AS PROD_KWRD
 , C.CNT AS kwrd_cnt
 , RANK() OVER(PARTITION BY C.IDKD_LCLS_CD_NM , C.IDKD_MCLS_CD_NM ORDER BY C.CNT DESC) AS kwrd_rank
 , C.PROD_SUM_AMT
 , C.PROD_MAX_AMT
 , C.PROD_AVG_AMT
FROM ( 
  SELECT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.KEYWORD_NM
   , COALESCE(B.CNT, 0) AS CNT
   , COALESCE(B.PROD_SUM_AMT, 0) AS PROD_SUM_AMT
   , COALESCE(B.PROD_MAX_AMT, 0) AS PROD_MAX_AMT
   , COALESCE(B.PROD_AVG_AMT, 0) AS PROD_AVG_AMT
  FROM (SELECT DISTINCT KEYWORD_NM
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_MCLS_CD_NM
      , IDKD_LCLS_CD_NM
     FROM  (
     SELECT  IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , INCL_KWRD_NM AS KEYWORD_NM
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '식품'
     AND IDKD_MCLS_CD_NM = '간식/가공식품'
     ) AS A1
     ) AS A
  LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_3_TEMP AS B
  ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.KEYWORD_NM = B.PROD_KWRD
  ) AS C
LEFT JOIN
(SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체') AS D
ON C.IDKD_LCLS_CD_NM = D.IDKD_LCLS_CD_NM AND C.IDKD_MCLS_CD_NM = D.IDKD_MCLS_CD_NM
--AND C.IDKD_LCLS_CD=D.IDKD_LCLS_CD AND C.IDKD_MCLS_CD=D.IDKD_MCLS_CD
  ;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_4_TEMP; 
---------------------------------------------------------------------------------
-- 점유율 구하기
---------------------------------------------------------------------------------- 
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_5_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_5_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_5_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_5_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.kwrd_rank-A.kwrd_rank) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_4_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
;
COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_5_TEMP;
/****************************************************************************************/
         -- 간식/가공식품 끝
/****************************************************************************************/

/****************************************************************************************/
         --농축수산물 시작
/****************************************************************************************/

--------------------------------------------------------------------------------------------------------------
--농축수산물 1달전
--------------------------------------------------------------------------------------------------------------

--농축수산물 1개월전 데이터 원천에서 가지고 온것중에 구매 ID 있는것 중복제거
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='농축수산물'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP ;




/*농축수산물 원천(1달전)으로부터 LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_1_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='농축수산물'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_1_TEMP ;

/* 농축수산물 원천(1달전)으로부터 LIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_2_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_AGR_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='농축수산물'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NOT NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_2_TEMP ;

/* 농축수산물 원천(1달전)으로부터  LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_3_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_AGR_LIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_AGR_LIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_INCL_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='농축수산물'
AND FST_INCL_KWRD_NM IS NOT NULL
AND SECD_INCL_KWRD_NM IS NULL
AND THRD_INCL_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_3_TEMP ;

/*  농축수산물 LIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_4_TEMP' AS
SELECT DISTINCT *
FROM (  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT,  INCL_KWRD_NM, FST_INCL_KWRD_NM, SECD_INCL_KWRD_NM, THRD_INCL_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_3_TEMP
 ) TMP
;



COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_4_TEMP ;

--NOTLIKE 시작
/* 농축수산물 원천(1달전)으로부터  NOTLIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_1_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_1_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_1_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='농축수산물'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NOT NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_1_TEMP ;

/*농축수산물 원천(1달전)으로부터 NOTLIKE STEP 2 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_2_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_AGR_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='농축수산물'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NOT NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_2_TEMP ;

/*농축수산물 원천(1달전)으로부터NOT LIKE STEP 3 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_3_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
FROM ( SELECT A1.*
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_1_TEMP AS A1
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_AGR_NOTLIKE_1_TEMP ) AS B1
--  ON A1.TRX_ID = B1.TRX_ID
--  LEFT ANTI JOIN ( SELECT DISTINCT TRX_ID
--       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_BO_1D_FOOD_AGR_NOTLIKE_2_TEMP ) AS C1
--  ON A1.TRX_ID = C1.TRX_ID
 ) AS A
INNER JOIN (SELECT * FROM BDPL200.L2COT_XCLN_KWRD_INFO
WHERE IDKD_MCLS_CD_NM='농축수산물'
AND FST_XCLN_KWRD_NM IS NOT NULL
AND SECD_XCLN_KWRD_NM IS NULL
AND THRD_XCLN_KWRD_NM IS NULL) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_3_TEMP ;

/*농축수산물  NOTLIKE 3개 UNION ALL */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_4_TEMP' AS
SELECT DISTINCT *
FROM ( SELECT IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm,  trx_id,  STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_1_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_2_TEMP UNION ALL
  SELECT  IDKD_LCLS_CD, IDKD_MCLS_CD, idkd_lcls_cd_nm, idkd_mcls_cd_nm, store_nm, elst_svc_nm, trx_id, STLM_AMT, XCLN_KWRD_NM, FST_XCLN_KWRD_NM, SECD_XCLN_KWRD_NM, THRD_XCLN_KWRD_NM FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_3_TEMP
) TMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_4_TEMP ;

---- 농축수산물(1달) 식별 <- LIKE, NOTLIKE 이용
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_2_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_2_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_2_TEMP' AS
SELECT
   A.IDKD_LCLS_CD
  , A.IDKD_MCLS_CD
  , A.idkd_lcls_cd_nm
  , A.idkd_mcls_cd_nm
  , A.store_nm
  , A.elst_svc_nm
  , A.trx_id
  , A.STLM_AMT
  , A.INCL_KWRD_NM AS prod_kwrd
 FROM ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , INCL_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_LIKE_4_TEMP ) AS A
left ANTI join ( SELECT DISTINCT
     IDKD_LCLS_CD
    , IDKD_MCLS_CD
    , idkd_lcls_cd_nm
    , idkd_mcls_cd_nm
    , store_nm
    , elst_svc_nm
    , trx_id
    , STLM_AMT
    , XCLN_KWRD_NM
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_NOTLIKE_4_TEMP ) AS B
--on A.MONTH_TRX_APRV_DT=B.MONTH_TRX_APRV_DT AND A.IDKD_LCLS_CD=B.IDKD_LCLS_CD AND A.IDKD_MCLS_CD=B.IDKD_MCLS_CD AND a.idkd_lcls_cd_nm=b.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm=B.idkd_mcls_cd_nm AND A.store_nm=B.store_nm AND A.elst_svc_nm=B.elst_svc_nm
ON A.TRX_ID=B.TRX_ID and a.INCL_KWRD_NM= b.XCLN_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_2_TEMP ;


----------------------------------------------------------------------------------
-- 식별 끝
----------------------------------------------------------------------------------

----------------------------------------------------------------------------------
-- 키워드 집계
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_3_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_3_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_3_TEMP' AS
SELECT
  IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , prod_kwrd
 , COUNT(prod_kwrd) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(prod_kwrd) >= 0 THEN SUM(STLM_AMT)/COUNT(prod_kwrd)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(prod_kwrd)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_2_TEMP
GROUP BY IDKD_LCLS_CD,IDKD_MCLS_CD,IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, prod_kwrd
;
COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_3_TEMP;
----------------------------------------------------------------------------------
-- 순위 산출 및 팔리지 않은 키워드 0 처리
----------------------------------------------------------------------------------

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_4_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_4_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_4_TEMP' AS
SELECT
  D.IDKD_CD
 , C.IDKD_LCLS_CD
 , C.IDKD_MCLS_CD
 , C.IDKD_LCLS_CD_NM
 , C.IDKD_MCLS_CD_NM
 , C.KEYWORD_NM AS PROD_KWRD
 , C.CNT AS kwrd_cnt
 , RANK() OVER(PARTITION BY C.IDKD_LCLS_CD_NM , C.IDKD_MCLS_CD_NM ORDER BY C.CNT DESC) AS kwrd_rank
 , C.PROD_SUM_AMT
 , C.PROD_MAX_AMT
 , C.PROD_AVG_AMT
FROM ( 
  SELECT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.KEYWORD_NM
   , COALESCE(B.CNT, 0) AS CNT
   , COALESCE(B.PROD_SUM_AMT, 0) AS PROD_SUM_AMT
   , COALESCE(B.PROD_MAX_AMT, 0) AS PROD_MAX_AMT
   , COALESCE(B.PROD_AVG_AMT, 0) AS PROD_AVG_AMT
  FROM (SELECT DISTINCT KEYWORD_NM
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_MCLS_CD_NM
      , IDKD_LCLS_CD_NM
     FROM  (
     SELECT  IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , INCL_KWRD_NM AS KEYWORD_NM
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '식품'
     AND IDKD_MCLS_CD_NM = '농축수산물'
     ) AS A1
     ) AS A
  LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_3_TEMP AS B
  ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.KEYWORD_NM = B.PROD_KWRD
  ) AS C
LEFT JOIN
(SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체') AS D
ON C.IDKD_LCLS_CD_NM = D.IDKD_LCLS_CD_NM AND C.IDKD_MCLS_CD_NM = D.IDKD_MCLS_CD_NM
--AND C.IDKD_LCLS_CD=D.IDKD_LCLS_CD AND C.IDKD_MCLS_CD=D.IDKD_MCLS_CD
  ;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_4_TEMP; 
---------------------------------------------------------------------------------
-- 점유율 구하기
---------------------------------------------------------------------------------- 
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_5_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_5_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_5_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_5_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.kwrd_rank-A.kwrd_rank) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_4_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_5_TEMP;
/****************************************************************************************/
         -- 농축수산물 끝
/****************************************************************************************/



/*********************************************************************/

   --인기상품순위 : 의류/패션

/*********************************************************************/

--남성패션시작

/********* PG 거래 원천에서 가져오기 *********/
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='남성패션'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP ;


/**************************************************** 패션 식별테이블 생성 **************************************************************/

/* LIKE 테이블 */


/*********************************************************************/

   -- 의류/패션
   
   -- 남성패션
   
   -- 형태 (SHAPE)

/********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '남성패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_02_TEMP ;



/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_03_TEMP ;


/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_04_TEMP ;

 

/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '남성패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션' ) AS A1
 ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_04_TEMP ;

/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_05_TEMP ;


/*********************************************************************/

   -- 의류/패션
   
   -- 남성패션
   
   -- 스타일 (STYLE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '남성패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_02_TEMP ;

/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_03_TEMP ;

/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_04_TEMP ;



/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '남성패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '남성패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_04_TEMP ;


/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_05_TEMP ;


----------- 20181020 여기까지 함

/************ 형태 + 스타일 결합 ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_FIND_05_TEMP AS A
LEFT ANTI JOIN ( SELECT TRX_ID
      , COUNT(KWRD_NM) AS CNT
     FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_05_TEMP
     GROUP BY TRX_ID
     HAVING CNT > 2 ) AS B -- 스타일 개수가 3개 이상인 것 제외
ON A.TRX_ID = B.TRX_ID
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_01_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.KWRD_NM AS ST_KWRD_NM
 , B.RN AS ST_RN
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_01_TEMP AS A
LEFT JOIN ( SELECT *
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_05_TEMP
    WHERE 1=1
     AND TRX_ID IN ( SELECT TRX_ID
         FROM ( SELECT TRX_ID
            , COUNT(KWRD_NM) AS CNT
           FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_STYLE_FIND_05_TEMP
           GROUP BY TRX_ID ) TMP
         WHERE 1=1
          AND CNT <= 2 )
   ) AS B
ON A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_02_TEMP ;

/*********** 가로로 형태, 스타일 키워드 컬럼 전환 *************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP' AS
SELECT
  *
 , CASE WHEN RN = 1 THEN KWRD_NM END AS SHAPE_1
 , CASE WHEN RN = 2 THEN KWRD_NM END AS SHAPE_2
 , CASE WHEN RN = 3 THEN KWRD_NM END AS SHAPE_3
 , CASE WHEN RN = 4 THEN KWRD_NM END AS SHAPE_4
 , CASE WHEN RN = 5 THEN KWRD_NM END AS SHAPE_5
 , CASE WHEN ST_RN = 1 THEN ST_KWRD_NM END AS STYLE_1
 , CASE WHEN ST_RN = 2 THEN ST_KWRD_NM END AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_02_TEMP
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_04_TEMP' AS
SELECT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , B.SHAPE_1
 , C.SHAPE_2
 , D.SHAPE_3
 , E.SHAPE_4
 , F.SHAPE_5
FROM ( SELECT DISTINCT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
   , TRX_ID
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_3
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_3 IS NOT NULL ) AS D
ON A.STORE_NM = D.STORE_NM AND A.ELST_SVC_NM = D.ELST_SVC_NM AND A.TRX_ID = D.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_4
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_4 IS NOT NULL ) AS E
ON A.STORE_NM = E.STORE_NM AND A.ELST_SVC_NM = E.ELST_SVC_NM AND A.TRX_ID = E.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_5
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_5 IS NOT NULL ) AS F
ON A.STORE_NM = F.STORE_NM AND A.ELST_SVC_NM = F.ELST_SVC_NM AND A.TRX_ID = F.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_04_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_05_TEMP' AS
SELECT
  A.*
 , B.STYLE_1
 , C.STYLE_2
FROM ( SELECT *
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_04_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_05_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_06_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_06_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_06_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_06_TEMP' AS
SELECT DISTINCT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , A.STLM_AMT
 , COALESCE(B.SHAPE_1, '') AS SHAPE_1
 , COALESCE(B.SHAPE_2, '') AS SHAPE_2
 , COALESCE(B.SHAPE_3, '') AS SHAPE_3
 , COALESCE(B.SHAPE_4, '') AS SHAPE_4
 , COALESCE(B.SHAPE_5, '') AS SHAPE_5
 , COALESCE(B.STYLE_1, '') AS STYLE_1
 , COALESCE(B.STYLE_2, '') AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_03_TEMP AS A
LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_05_TEMP AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_06_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_07_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_07_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_07_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_07_TEMP' AS
SELECT *
 , CONCAT(STYLE_1, STYLE_2, SHAPE_1, SHAPE_2, SHAPE_3, SHAPE_4, SHAPE_5) AS STYLE_SHAPE_KWRD
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_06_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_07_TEMP ;


/****************** 대분류, 중분류, 키워드 로 집계 **********************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_08_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_08_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_08_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_08_TEMP' AS
SELECT
  IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , STYLE_SHAPE_KWRD
 , COUNT(STYLE_SHAPE_KWRD) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD) >= 0 THEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_07_TEMP
GROUP BY IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, STYLE_SHAPE_KWRD
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_08_TEMP ;


/****************** 순위 산출 ******************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_09_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_09_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_09_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_09_TEMP' AS

SELECT  B.IDKD_CD
 , B.IDKD_LCLS_CD
 , B.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STYLE_SHAPE_KWRD AS PROD_KWRD
 , A.CNT AS KWRD_CNT
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , RANK() OVER(PARTITION BY A.IDKD_LCLS_CD_NM , A.IDKD_MCLS_CD_NM ORDER BY A.CNT DESC) AS KWRD_RANK
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_08_TEMP AS A
LEFT JOIN
(SELECT      IDKD_CD
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_LCLS_CD_NM
      , IDKD_MCLS_CD_NM
     FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
     WHERE 1=1
      AND IDKD_SCLS_CD_NM = '전체') AS B
ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_09_TEMP ;
  
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_10_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_10_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_10_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_10_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.KWRD_RANK-A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_09_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
; 

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_10_TEMP ;


--남성패션끝



--여성패션시작

/********* PG 거래 원천에서 가져오기 *********/
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='여성패션'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP ;


/**************************************************** 패션 식별테이블 생성 **************************************************************/

/* LIKE 테이블 */


/*********************************************************************/

   -- 의류/패션
   
   -- 여성패션
   
   -- 형태 (SHAPE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '여성패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_02_TEMP ;



/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_03_TEMP ;


/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_04_TEMP ;



/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '여성패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션' ) AS A1
 ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_04_TEMP ;

/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_05_TEMP ;


/*********************************************************************/

   -- 의류/패션
   
   -- 여성패션
   
   -- 스타일 (STYLE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '여성패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_02_TEMP ;

/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_03_TEMP ;

/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_04_TEMP ;



/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '여성패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '여성패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_04_TEMP ;


/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_05_TEMP ;




/************ 형태 + 스타일 결합 ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_FIND_05_TEMP AS A
LEFT ANTI JOIN ( SELECT TRX_ID
      , COUNT(KWRD_NM) AS CNT
     FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_05_TEMP
     GROUP BY TRX_ID
     HAVING CNT > 2 ) AS B -- 스타일 개수가 3개 이상인 것 제외
ON A.TRX_ID = B.TRX_ID
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_01_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.KWRD_NM AS ST_KWRD_NM
 , B.RN AS ST_RN
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_01_TEMP AS A
LEFT JOIN ( SELECT *
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_05_TEMP
    WHERE 1=1
     AND TRX_ID IN ( SELECT TRX_ID
         FROM ( SELECT TRX_ID
            , COUNT(KWRD_NM) AS CNT
           FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_STYLE_FIND_05_TEMP
           GROUP BY TRX_ID ) TMP
         WHERE 1=1
          AND CNT <= 2 )
   ) AS B
ON A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_02_TEMP ;

/*********** 가로로 형태, 스타일 키워드 컬럼 전환 *************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP' AS
SELECT
  *
 , CASE WHEN RN = 1 THEN KWRD_NM END AS SHAPE_1
 , CASE WHEN RN = 2 THEN KWRD_NM END AS SHAPE_2
 , CASE WHEN RN = 3 THEN KWRD_NM END AS SHAPE_3
 , CASE WHEN RN = 4 THEN KWRD_NM END AS SHAPE_4
 , CASE WHEN RN = 5 THEN KWRD_NM END AS SHAPE_5
 , CASE WHEN ST_RN = 1 THEN ST_KWRD_NM END AS STYLE_1
 , CASE WHEN ST_RN = 2 THEN ST_KWRD_NM END AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_02_TEMP
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_04_TEMP' AS
SELECT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , B.SHAPE_1
 , C.SHAPE_2
 , D.SHAPE_3
 , E.SHAPE_4
 , F.SHAPE_5
FROM ( SELECT DISTINCT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
   , TRX_ID
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_3
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_3 IS NOT NULL ) AS D
ON A.STORE_NM = D.STORE_NM AND A.ELST_SVC_NM = D.ELST_SVC_NM AND A.TRX_ID = D.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_4
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_4 IS NOT NULL ) AS E
ON A.STORE_NM = E.STORE_NM AND A.ELST_SVC_NM = E.ELST_SVC_NM AND A.TRX_ID = E.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_5
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_5 IS NOT NULL ) AS F
ON A.STORE_NM = F.STORE_NM AND A.ELST_SVC_NM = F.ELST_SVC_NM AND A.TRX_ID = F.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_04_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_05_TEMP' AS
SELECT
  A.*
 , B.STYLE_1
 , C.STYLE_2
FROM ( SELECT *
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_04_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_05_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_06_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_06_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_06_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_06_TEMP' AS
SELECT DISTINCT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , A.STLM_AMT
 , COALESCE(B.SHAPE_1, '') AS SHAPE_1
 , COALESCE(B.SHAPE_2, '') AS SHAPE_2
 , COALESCE(B.SHAPE_3, '') AS SHAPE_3
 , COALESCE(B.SHAPE_4, '') AS SHAPE_4
 , COALESCE(B.SHAPE_5, '') AS SHAPE_5
 , COALESCE(B.STYLE_1, '') AS STYLE_1
 , COALESCE(B.STYLE_2, '') AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_03_TEMP AS A
LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_05_TEMP AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_06_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_07_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_07_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_07_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_07_TEMP' AS
SELECT *
 , CONCAT(STYLE_1, STYLE_2, SHAPE_1, SHAPE_2, SHAPE_3, SHAPE_4, SHAPE_5) AS STYLE_SHAPE_KWRD
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_06_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_07_TEMP ;


/****************** 대분류, 중분류, 키워드 로 집계 **********************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_08_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_08_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_08_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_08_TEMP' AS
SELECT
  IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , STYLE_SHAPE_KWRD
 , COUNT(STYLE_SHAPE_KWRD) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD) >= 0 THEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_07_TEMP
GROUP BY IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, STYLE_SHAPE_KWRD
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_08_TEMP ;


/****************** 순위 산출 ******************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_09_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_09_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_09_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_09_TEMP' AS

SELECT  B.IDKD_CD
 , B.IDKD_LCLS_CD
 , B.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STYLE_SHAPE_KWRD AS PROD_KWRD
 , A.CNT AS KWRD_CNT
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , RANK() OVER(PARTITION BY A.IDKD_LCLS_CD_NM , A.IDKD_MCLS_CD_NM ORDER BY A.CNT DESC) AS KWRD_RANK
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_08_TEMP AS A
LEFT JOIN
(SELECT      IDKD_CD
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_LCLS_CD_NM
      , IDKD_MCLS_CD_NM
     FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
     WHERE 1=1
      AND IDKD_SCLS_CD_NM = '전체') AS B
ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_09_TEMP ;
  
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_10_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_10_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_10_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_10_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.KWRD_RANK-A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_09_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
; 
 
COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_10_TEMP ;


--여성패션끝



--잡화시작

/********* PG 거래 원천에서 가져오기 *********/
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='잡화'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP ;


/**************************************************** 패션 식별테이블 생성 **************************************************************/

/* LIKE 테이블 */


/*********************************************************************/

   -- 의류/패션
   
   -- 잡화
   
   -- 형태 (SHAPE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '잡화'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_02_TEMP ;



/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_03_TEMP ;


/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_04_TEMP ;



/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '잡화'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화' ) AS A1
 ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_04_TEMP ;

/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_05_TEMP ;


/*********************************************************************/

   -- 의류/패션
   
   -- 잡화
   
   -- 스타일 (STYLE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '잡화'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_02_TEMP ;

/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_03_TEMP ;

/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_04_TEMP ;



/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '잡화'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '잡화'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_04_TEMP ;


/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_05_TEMP ;




/************ 형태 + 스타일 결합 ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_FIND_05_TEMP AS A
LEFT ANTI JOIN ( SELECT TRX_ID
      , COUNT(KWRD_NM) AS CNT
     FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_05_TEMP
     GROUP BY TRX_ID
     HAVING CNT > 2 ) AS B -- 스타일 개수가 3개 이상인 것 제외
ON A.TRX_ID = B.TRX_ID
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_01_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.KWRD_NM AS ST_KWRD_NM
 , B.RN AS ST_RN
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_01_TEMP AS A
LEFT JOIN ( SELECT *
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_05_TEMP
    WHERE 1=1
     AND TRX_ID IN ( SELECT TRX_ID
         FROM ( SELECT TRX_ID
            , COUNT(KWRD_NM) AS CNT
           FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_STYLE_FIND_05_TEMP
           GROUP BY TRX_ID ) TMP
         WHERE 1=1
          AND CNT <= 2 )
   ) AS B
ON A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_02_TEMP ;

/*********** 가로로 형태, 스타일 키워드 컬럼 전환 *************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP' AS
SELECT
  *
 , CASE WHEN RN = 1 THEN KWRD_NM END AS SHAPE_1
 , CASE WHEN RN = 2 THEN KWRD_NM END AS SHAPE_2
 , CASE WHEN RN = 3 THEN KWRD_NM END AS SHAPE_3
 , CASE WHEN RN = 4 THEN KWRD_NM END AS SHAPE_4
 , CASE WHEN RN = 5 THEN KWRD_NM END AS SHAPE_5
 , CASE WHEN ST_RN = 1 THEN ST_KWRD_NM END AS STYLE_1
 , CASE WHEN ST_RN = 2 THEN ST_KWRD_NM END AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_02_TEMP
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_04_TEMP' AS
SELECT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , B.SHAPE_1
 , C.SHAPE_2
 , D.SHAPE_3
 , E.SHAPE_4
 , F.SHAPE_5
FROM ( SELECT DISTINCT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
   , TRX_ID
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_3
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_3 IS NOT NULL ) AS D
ON A.STORE_NM = D.STORE_NM AND A.ELST_SVC_NM = D.ELST_SVC_NM AND A.TRX_ID = D.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_4
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_4 IS NOT NULL ) AS E
ON A.STORE_NM = E.STORE_NM AND A.ELST_SVC_NM = E.ELST_SVC_NM AND A.TRX_ID = E.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_5
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_5 IS NOT NULL ) AS F
ON A.STORE_NM = F.STORE_NM AND A.ELST_SVC_NM = F.ELST_SVC_NM AND A.TRX_ID = F.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_04_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_05_TEMP' AS
SELECT
  A.*
 , B.STYLE_1
 , C.STYLE_2
FROM ( SELECT *
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_04_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_05_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_06_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_06_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_06_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_06_TEMP' AS
SELECT DISTINCT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , A.STLM_AMT
 , COALESCE(B.SHAPE_1, '') AS SHAPE_1
 , COALESCE(B.SHAPE_2, '') AS SHAPE_2
 , COALESCE(B.SHAPE_3, '') AS SHAPE_3
 , COALESCE(B.SHAPE_4, '') AS SHAPE_4
 , COALESCE(B.SHAPE_5, '') AS SHAPE_5
 , COALESCE(B.STYLE_1, '') AS STYLE_1
 , COALESCE(B.STYLE_2, '') AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_03_TEMP AS A
LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_05_TEMP AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_06_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_07_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_07_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_07_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_07_TEMP' AS
SELECT *
 , CONCAT(STYLE_1, STYLE_2, SHAPE_1, SHAPE_2, SHAPE_3, SHAPE_4, SHAPE_5) AS STYLE_SHAPE_KWRD
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_06_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_07_TEMP ;


/****************** 대분류, 중분류, 키워드 로 집계 **********************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_08_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_08_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_08_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_08_TEMP' AS
SELECT
  IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , STYLE_SHAPE_KWRD
 , COUNT(STYLE_SHAPE_KWRD) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD) >= 0 THEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_07_TEMP
GROUP BY IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, STYLE_SHAPE_KWRD
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_08_TEMP ;


/****************** 순위 산출 ******************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_09_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_09_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_09_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_09_TEMP' AS

SELECT  B.IDKD_CD
 , B.IDKD_LCLS_CD
 , B.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STYLE_SHAPE_KWRD AS PROD_KWRD
 , A.CNT AS KWRD_CNT
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , RANK() OVER(PARTITION BY A.IDKD_LCLS_CD_NM , A.IDKD_MCLS_CD_NM ORDER BY A.CNT DESC) AS KWRD_RANK
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_08_TEMP AS A
LEFT JOIN
(SELECT      IDKD_CD
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_LCLS_CD_NM
      , IDKD_MCLS_CD_NM
     FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
     WHERE 1=1
      AND IDKD_SCLS_CD_NM = '전체') AS B
ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_09_TEMP ;
  
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_10_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_10_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_10_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_10_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.KWRD_RANK-A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_09_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
; 

 
COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_10_TEMP ;


--잡화끝



--스포츠시작

/********* PG 거래 원천에서 가져오기 *********/
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='스포츠'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP ;


/**************************************************** 패션 식별테이블 생성 **************************************************************/

/* LIKE 테이블 */


/*********************************************************************/

   -- 의류/패션
   
   -- 스포츠
   
   -- 형태 (SHAPE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '스포츠'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_02_TEMP ;



/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_03_TEMP ;


/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_04_TEMP ;



/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '스포츠'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠' ) AS A1
 ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_04_TEMP ;

/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_05_TEMP ;


/*********************************************************************/

   -- 의류/패션
   
   -- 스포츠
   
   -- 스타일 (STYLE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '스포츠'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_02_TEMP ;

/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_03_TEMP ;

/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_04_TEMP ;



/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '스포츠'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '스포츠'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_04_TEMP ;


/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_05_TEMP ;



/************ 형태 + 스타일 결합 ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_FIND_05_TEMP AS A
LEFT ANTI JOIN ( SELECT TRX_ID
      , COUNT(KWRD_NM) AS CNT
     FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_05_TEMP
     GROUP BY TRX_ID
     HAVING CNT > 2 ) AS B -- 스타일 개수가 3개 이상인 것 제외
ON A.TRX_ID = B.TRX_ID
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_01_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.KWRD_NM AS ST_KWRD_NM
 , B.RN AS ST_RN
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_01_TEMP AS A
LEFT JOIN ( SELECT *
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_05_TEMP
    WHERE 1=1
     AND TRX_ID IN ( SELECT TRX_ID
         FROM ( SELECT TRX_ID
            , COUNT(KWRD_NM) AS CNT
           FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_STYLE_FIND_05_TEMP
           GROUP BY TRX_ID ) TMP
         WHERE 1=1
          AND CNT <= 2 )
   ) AS B
ON A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_02_TEMP ;

/*********** 가로로 형태, 스타일 키워드 컬럼 전환 *************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP' AS
SELECT
  *
 , CASE WHEN RN = 1 THEN KWRD_NM END AS SHAPE_1
 , CASE WHEN RN = 2 THEN KWRD_NM END AS SHAPE_2
 , CASE WHEN RN = 3 THEN KWRD_NM END AS SHAPE_3
 , CASE WHEN RN = 4 THEN KWRD_NM END AS SHAPE_4
 , CASE WHEN RN = 5 THEN KWRD_NM END AS SHAPE_5
 , CASE WHEN ST_RN = 1 THEN ST_KWRD_NM END AS STYLE_1
 , CASE WHEN ST_RN = 2 THEN ST_KWRD_NM END AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_02_TEMP
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_04_TEMP' AS
SELECT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , B.SHAPE_1
 , C.SHAPE_2
 , D.SHAPE_3
 , E.SHAPE_4
 , F.SHAPE_5
FROM ( SELECT DISTINCT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
   , TRX_ID
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_3
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_3 IS NOT NULL ) AS D
ON A.STORE_NM = D.STORE_NM AND A.ELST_SVC_NM = D.ELST_SVC_NM AND A.TRX_ID = D.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_4
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_4 IS NOT NULL ) AS E
ON A.STORE_NM = E.STORE_NM AND A.ELST_SVC_NM = E.ELST_SVC_NM AND A.TRX_ID = E.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_5
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_5 IS NOT NULL ) AS F
ON A.STORE_NM = F.STORE_NM AND A.ELST_SVC_NM = F.ELST_SVC_NM AND A.TRX_ID = F.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_04_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_05_TEMP' AS
SELECT
  A.*
 , B.STYLE_1
 , C.STYLE_2
FROM ( SELECT *
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_04_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_05_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_06_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_06_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_06_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_06_TEMP' AS
SELECT DISTINCT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , A.STLM_AMT
 , COALESCE(B.SHAPE_1, '') AS SHAPE_1
 , COALESCE(B.SHAPE_2, '') AS SHAPE_2
 , COALESCE(B.SHAPE_3, '') AS SHAPE_3
 , COALESCE(B.SHAPE_4, '') AS SHAPE_4
 , COALESCE(B.SHAPE_5, '') AS SHAPE_5
 , COALESCE(B.STYLE_1, '') AS STYLE_1
 , COALESCE(B.STYLE_2, '') AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_03_TEMP AS A
LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_05_TEMP AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_06_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_07_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_07_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_07_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_07_TEMP' AS
SELECT *
 , CONCAT(STYLE_1, STYLE_2, SHAPE_1, SHAPE_2, SHAPE_3, SHAPE_4, SHAPE_5) AS STYLE_SHAPE_KWRD
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_06_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_07_TEMP ;


/****************** 대분류, 중분류, 키워드 로 집계 **********************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_08_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_08_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_08_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_08_TEMP' AS
SELECT
  IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , STYLE_SHAPE_KWRD
 , COUNT(STYLE_SHAPE_KWRD) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD) >= 0 THEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_07_TEMP
GROUP BY IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, STYLE_SHAPE_KWRD
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_08_TEMP ;


/****************** 순위 산출 ******************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_09_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_09_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_09_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_09_TEMP' AS

SELECT  B.IDKD_CD
 , B.IDKD_LCLS_CD
 , B.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STYLE_SHAPE_KWRD AS PROD_KWRD
 , A.CNT AS KWRD_CNT
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , RANK() OVER(PARTITION BY A.IDKD_LCLS_CD_NM , A.IDKD_MCLS_CD_NM ORDER BY A.CNT DESC) AS KWRD_RANK
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_08_TEMP AS A
LEFT JOIN
(SELECT      IDKD_CD
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_LCLS_CD_NM
      , IDKD_MCLS_CD_NM
     FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
     WHERE 1=1
      AND IDKD_SCLS_CD_NM = '전체') AS B
ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_09_TEMP ;
  
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_10_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_10_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_10_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_10_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.KWRD_RANK-A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_09_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
; 

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_10_TEMP ;


--스포츠끝


--전문패션시작

/********* PG 거래 원천에서 가져오기 *********/
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='전문패션'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP ;


/**************************************************** 패션 식별테이블 생성 **************************************************************/

/* LIKE 테이블 */


/*********************************************************************/

   -- 의류/패션
   
   -- 전문패션
   
   -- 형태 (SHAPE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '전문패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_02_TEMP ;



/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_03_TEMP ;


/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_04_TEMP ;


/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '전문패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션' ) AS A1
 ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_04_TEMP ;

/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_05_TEMP ;


/*********************************************************************/

   -- 의류/패션
   
   -- 전문패션
   
   -- 스타일 (STYLE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '전문패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_02_TEMP ;

/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_03_TEMP ;

/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_04_TEMP ;



/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '전문패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '전문패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_04_TEMP ;


/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_05_TEMP ;



/************ 형태 + 스타일 결합 ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_FIND_05_TEMP AS A
LEFT ANTI JOIN ( SELECT TRX_ID
      , COUNT(KWRD_NM) AS CNT
     FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_05_TEMP
     GROUP BY TRX_ID
     HAVING CNT > 2 ) AS B -- 스타일 개수가 3개 이상인 것 제외
ON A.TRX_ID = B.TRX_ID
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_01_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.KWRD_NM AS ST_KWRD_NM
 , B.RN AS ST_RN
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_01_TEMP AS A
LEFT JOIN ( SELECT *
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_05_TEMP
    WHERE 1=1
     AND TRX_ID IN ( SELECT TRX_ID
         FROM ( SELECT TRX_ID
            , COUNT(KWRD_NM) AS CNT
           FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_STYLE_FIND_05_TEMP
           GROUP BY TRX_ID ) TMP
         WHERE 1=1
          AND CNT <= 2 )
   ) AS B
ON A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_02_TEMP ;

/*********** 가로로 형태, 스타일 키워드 컬럼 전환 *************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP' AS
SELECT
  *
 , CASE WHEN RN = 1 THEN KWRD_NM END AS SHAPE_1
 , CASE WHEN RN = 2 THEN KWRD_NM END AS SHAPE_2
 , CASE WHEN RN = 3 THEN KWRD_NM END AS SHAPE_3
 , CASE WHEN RN = 4 THEN KWRD_NM END AS SHAPE_4
 , CASE WHEN RN = 5 THEN KWRD_NM END AS SHAPE_5
 , CASE WHEN ST_RN = 1 THEN ST_KWRD_NM END AS STYLE_1
 , CASE WHEN ST_RN = 2 THEN ST_KWRD_NM END AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_02_TEMP
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_04_TEMP' AS
SELECT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , B.SHAPE_1
 , C.SHAPE_2
 , D.SHAPE_3
 , E.SHAPE_4
 , F.SHAPE_5
FROM ( SELECT DISTINCT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
   , TRX_ID
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_3
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_3 IS NOT NULL ) AS D
ON A.STORE_NM = D.STORE_NM AND A.ELST_SVC_NM = D.ELST_SVC_NM AND A.TRX_ID = D.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_4
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_4 IS NOT NULL ) AS E
ON A.STORE_NM = E.STORE_NM AND A.ELST_SVC_NM = E.ELST_SVC_NM AND A.TRX_ID = E.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_5
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_5 IS NOT NULL ) AS F
ON A.STORE_NM = F.STORE_NM AND A.ELST_SVC_NM = F.ELST_SVC_NM AND A.TRX_ID = F.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_04_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_05_TEMP' AS
SELECT
  A.*
 , B.STYLE_1
 , C.STYLE_2
FROM ( SELECT *
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_04_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_05_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_06_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_06_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_06_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_06_TEMP' AS
SELECT DISTINCT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , A.STLM_AMT
 , COALESCE(B.SHAPE_1, '') AS SHAPE_1
 , COALESCE(B.SHAPE_2, '') AS SHAPE_2
 , COALESCE(B.SHAPE_3, '') AS SHAPE_3
 , COALESCE(B.SHAPE_4, '') AS SHAPE_4
 , COALESCE(B.SHAPE_5, '') AS SHAPE_5
 , COALESCE(B.STYLE_1, '') AS STYLE_1
 , COALESCE(B.STYLE_2, '') AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_03_TEMP AS A
LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_05_TEMP AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_06_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_07_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_07_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_07_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_07_TEMP' AS
SELECT *
 , CONCAT(STYLE_1, STYLE_2, SHAPE_1, SHAPE_2, SHAPE_3, SHAPE_4, SHAPE_5) AS STYLE_SHAPE_KWRD
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_06_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_07_TEMP ;


/****************** 대분류, 중분류, 키워드 로 집계 **********************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_08_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_08_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_08_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_08_TEMP' AS
SELECT
  IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , STYLE_SHAPE_KWRD
 , COUNT(STYLE_SHAPE_KWRD) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD) >= 0 THEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_07_TEMP
GROUP BY IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, STYLE_SHAPE_KWRD
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_08_TEMP ;


/****************** 순위 산출 ******************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_09_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_09_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_09_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_09_TEMP' AS

SELECT  B.IDKD_CD
 , B.IDKD_LCLS_CD
 , B.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STYLE_SHAPE_KWRD AS PROD_KWRD
 , A.CNT AS KWRD_CNT
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , RANK() OVER(PARTITION BY A.IDKD_LCLS_CD_NM , A.IDKD_MCLS_CD_NM ORDER BY A.CNT DESC) AS KWRD_RANK
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_08_TEMP AS A
LEFT JOIN
(SELECT      IDKD_CD
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_LCLS_CD_NM
      , IDKD_MCLS_CD_NM
     FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
     WHERE 1=1
      AND IDKD_SCLS_CD_NM = '전체') AS B
ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_09_TEMP ;
  
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_10_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_10_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_10_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_10_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.KWRD_RANK-A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_09_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
; 

 
COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_10_TEMP ;


--전문패션끝



/*********************************************************************/

   --인기상품순위 : 의류/패션

/*********************************************************************/
--브랜드패션시작

/********* PG 거래 원천에서 가져오기 *********/
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP' AS
SELECT *
FROM (
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TR_ELST_SVC_NM AS ELST_SVC_NM
, ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
, TRX_ID
, STLM_AMT
FROM(
SELECT
idkd_lcls_cd
,idkd_mcls_cd
,IDKD_LCLS_CD_NM
, IDKD_MCLS_CD_NM
, STORE_NM
, TRIM(ELST_SVC_NM) AS TR_ELST_SVC_NM
, TRX_ID
, STLM_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_RAW_01_TEMP
WHERE  idkd_mcls_cd_nm='브랜드패션'
) AS A
) AS B
WHERE NEW_TRX_ID=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP ;


/**************************************************** 패션 식별테이블 생성 **************************************************************/

/* LIKE 테이블 */


/*********************************************************************/

   -- 의류/패션
   
   -- 브랜드패션
   
   -- 형태 (SHAPE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '브랜드패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_02_TEMP ;



/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '2'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_03_TEMP ;


/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_04_TEMP ;



/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '브랜드패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션' ) AS A1 
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션' ) AS A1
 ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '2'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_04_TEMP ;

/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_05_TEMP ;


/*********************************************************************/

   -- 의류/패션
   
   -- 브랜드패션
   
   -- 스타일 (STYLE)

/*********************************************************************/


/* LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '브랜드패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_01_TEMP ;


/* LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NOT NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_02_TEMP ;

/* LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_03_TEMP' AS
SELECT
  A.*
 , B.INCL_KWRD_NM AS KWRD_NM
 , B.FST_INCL_KWRD_NM
 , B.SECD_INCL_KWRD_NM
 , B.THRD_INCL_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.INCL_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_INCL_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '1'
     AND SECD_INCL_KWRD_NM IS NULL
     AND THRD_INCL_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_INCL_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_INCL_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_03_TEMP ;

/* LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_04_TEMP ;



/* NOT LIKE STEP 1 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_01_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
--   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
   , TRX_ID
   , STLM_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
  WHERE 1=1
   AND IDKD_LCLS_CD_NM = '의류/패션'
   AND IDKD_MCLS_CD_NM = '브랜드패션'
  )AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NOT NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_01_TEMP ;

/* NOT LIKE STEP 2 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_02_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NOT NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
 AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_02_TEMP ;


/* NOT LIKE STEP 3 */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_03_TEMP' AS
SELECT
  A.*
 , B.XCLN_KWRD_NM AS KWRD_NM
 , B.FST_XCLN_KWRD_NM
 , B.SECD_XCLN_KWRD_NM
 , B.THRD_XCLN_KWRD_NM
 , B.CATG2
 , B.CATG2_ORD
 , B.XCLN_KWRD_ORD
FROM ( SELECT A1.*
  FROM ( SELECT
      IDKD_LCLS_CD
     , IDKD_MCLS_CD
     , IDKD_LCLS_CD_NM
     , IDKD_MCLS_CD_NM
     , STORE_NM
     , ELST_SVC_NM
  --   , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY STLM_AMT DESC) AS NEW_TRX_ID
     , TRX_ID
     , STLM_AMT
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_TRX_02_TEMP
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션' ) AS A1
  ) AS A
INNER JOIN ( SELECT *
    FROM BDPL200.L2COT_XCLN_KWRD_INFO
    WHERE 1=1
     AND IDKD_LCLS_CD_NM = '의류/패션'
     AND IDKD_MCLS_CD_NM = '브랜드패션'
     AND CATG1_CD = '1'
     AND SECD_XCLN_KWRD_NM IS NULL
     AND THRD_XCLN_KWRD_NM IS NULL ) AS B
ON A.ELST_SVC_NM LIKE CONCAT('%', B.FST_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.SECD_XCLN_KWRD_NM, '%')
-- AND A.ELST_SVC_NM LIKE CONCAT('%', B.THRD_XCLN_KWRD_NM, '%')
WHERE 1=1
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_03_TEMP ;

/* NOT LIKE 3개 UNION ALL */

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_04_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_01_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_02_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_03_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_04_TEMP ;


/*********** LIKE 에서 NOT LIKE 제거(ANTI JOIN) ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_05_TEMP' AS
SELECT *
 , ROW_NUMBER() OVER(PARTITION BY TRX_ID ORDER BY CATG2_ORD, INCL_KWRD_ORD) AS RN
FROM ( SELECT DISTINCT
    A.IDKD_LCLS_CD
   , A.IDKD_MCLS_CD
   , A.IDKD_LCLS_CD_NM
   , A.IDKD_MCLS_CD_NM
   , A.STORE_NM
   , A.ELST_SVC_NM
   , A.TRX_ID
   , A.STLM_AMT
   , A.KWRD_NM
   , A.CATG2_ORD
   , A.INCL_KWRD_ORD
  FROM ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , INCL_KWRD_ORD
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_04_TEMP ) AS A
  LEFT ANTI JOIN ( SELECT DISTINCT
         IDKD_LCLS_CD
        , IDKD_MCLS_CD
        , IDKD_LCLS_CD_NM
        , IDKD_MCLS_CD_NM
        , STORE_NM
        , ELST_SVC_NM
        , TRX_ID
        , STLM_AMT
        , KWRD_NM
        , CATG2_ORD
        , XCLN_KWRD_ORD
       FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_NOT_FIND_04_TEMP ) AS B
  ON A.TRX_ID = B.TRX_ID AND A.KWRD_NM = B.KWRD_NM
 ) TMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_05_TEMP ;



/************ 형태 + 스타일 결합 ************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_01_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_01_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_01_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_01_TEMP' AS
SELECT
  A.*
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_FIND_05_TEMP AS A
LEFT ANTI JOIN ( SELECT TRX_ID
      , COUNT(KWRD_NM) AS CNT
     FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_05_TEMP
     GROUP BY TRX_ID
     HAVING CNT > 2 ) AS B -- 스타일 개수가 3개 이상인 것 제외
ON A.TRX_ID = B.TRX_ID
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_01_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_02_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_02_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_02_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_02_TEMP' AS
SELECT
  A.*
 , B.KWRD_NM AS ST_KWRD_NM
 , B.RN AS ST_RN
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_01_TEMP AS A
LEFT JOIN ( SELECT *
    FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_05_TEMP
    WHERE 1=1
     AND TRX_ID IN ( SELECT TRX_ID
         FROM ( SELECT TRX_ID
            , COUNT(KWRD_NM) AS CNT
           FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_STYLE_FIND_05_TEMP
           GROUP BY TRX_ID ) TMP
         WHERE 1=1
          AND CNT <= 2 )
   ) AS B
ON A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_02_TEMP ;

/*********** 가로로 형태, 스타일 키워드 컬럼 전환 *************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP' AS
SELECT
  *
 , CASE WHEN RN = 1 THEN KWRD_NM END AS SHAPE_1
 , CASE WHEN RN = 2 THEN KWRD_NM END AS SHAPE_2
 , CASE WHEN RN = 3 THEN KWRD_NM END AS SHAPE_3
 , CASE WHEN RN = 4 THEN KWRD_NM END AS SHAPE_4
 , CASE WHEN RN = 5 THEN KWRD_NM END AS SHAPE_5
 , CASE WHEN ST_RN = 1 THEN ST_KWRD_NM END AS STYLE_1
 , CASE WHEN ST_RN = 2 THEN ST_KWRD_NM END AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_02_TEMP
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_04_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_04_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_04_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_04_TEMP' AS
SELECT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , B.SHAPE_1
 , C.SHAPE_2
 , D.SHAPE_3
 , E.SHAPE_4
 , F.SHAPE_5
FROM ( SELECT DISTINCT
    IDKD_LCLS_CD
   , IDKD_MCLS_CD
   , IDKD_LCLS_CD_NM
   , IDKD_MCLS_CD_NM
   , STORE_NM
   , ELST_SVC_NM
   , TRX_ID
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_3
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_3 IS NOT NULL ) AS D
ON A.STORE_NM = D.STORE_NM AND A.ELST_SVC_NM = D.ELST_SVC_NM AND A.TRX_ID = D.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_4
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_4 IS NOT NULL ) AS E
ON A.STORE_NM = E.STORE_NM AND A.ELST_SVC_NM = E.ELST_SVC_NM AND A.TRX_ID = E.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , SHAPE_5
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND SHAPE_5 IS NOT NULL ) AS F
ON A.STORE_NM = F.STORE_NM AND A.ELST_SVC_NM = F.ELST_SVC_NM AND A.TRX_ID = F.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_04_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_05_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_05_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_05_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_05_TEMP' AS
SELECT
  A.*
 , B.STYLE_1
 , C.STYLE_2
FROM ( SELECT *
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_04_TEMP ) AS A
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_1
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_1 IS NOT NULL ) AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
LEFT JOIN ( SELECT DISTINCT
     STORE_NM
    , ELST_SVC_NM
    , TRX_ID
    , STYLE_2
   FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP
   WHERE 1=1
    AND STYLE_2 IS NOT NULL ) AS C
ON A.STORE_NM = C.STORE_NM AND A.ELST_SVC_NM = C.ELST_SVC_NM AND A.TRX_ID = C.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_05_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_06_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_06_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_06_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_06_TEMP' AS
SELECT DISTINCT
  A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STORE_NM
 , A.ELST_SVC_NM
 , A.TRX_ID
 , A.STLM_AMT
 , COALESCE(B.SHAPE_1, '') AS SHAPE_1
 , COALESCE(B.SHAPE_2, '') AS SHAPE_2
 , COALESCE(B.SHAPE_3, '') AS SHAPE_3
 , COALESCE(B.SHAPE_4, '') AS SHAPE_4
 , COALESCE(B.SHAPE_5, '') AS SHAPE_5
 , COALESCE(B.STYLE_1, '') AS STYLE_1
 , COALESCE(B.STYLE_2, '') AS STYLE_2
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_03_TEMP AS A
LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_05_TEMP AS B
ON A.STORE_NM = B.STORE_NM AND A.ELST_SVC_NM = B.ELST_SVC_NM AND A.TRX_ID = B.TRX_ID
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_06_TEMP ;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_07_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_07_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_07_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_07_TEMP' AS
SELECT *
 , CONCAT(STYLE_1, STYLE_2, SHAPE_1, SHAPE_2, SHAPE_3, SHAPE_4, SHAPE_5) AS STYLE_SHAPE_KWRD
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_06_TEMP
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_07_TEMP ;


/****************** 대분류, 중분류, 키워드 로 집계 **********************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_08_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_08_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_08_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_08_TEMP' AS
SELECT
  IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , STYLE_SHAPE_KWRD
 , COUNT(STYLE_SHAPE_KWRD) AS CNT
 , SUM(STLM_AMT) AS PROD_SUM_AMT
 , MAX(STLM_AMT) AS PROD_MAX_AMT
 , CASE WHEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD) >= 0 THEN SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)
   WHEN IS_NAN(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   WHEN IS_INF(SUM(STLM_AMT)/COUNT(STYLE_SHAPE_KWRD)) = 1 THEN NULL
   ELSE NULL
   END AS PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_07_TEMP
GROUP BY IDKD_LCLS_CD_NM, IDKD_MCLS_CD_NM, STYLE_SHAPE_KWRD
;

COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_08_TEMP ;


/****************** 순위 산출 ******************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_09_TEMP ;
--TRUNCATE TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_09_TEMP ;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_09_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_09_TEMP' AS

SELECT  B.IDKD_CD
 , B.IDKD_LCLS_CD
 , B.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.STYLE_SHAPE_KWRD AS PROD_KWRD
 , A.CNT AS KWRD_CNT
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , RANK() OVER(PARTITION BY A.IDKD_LCLS_CD_NM , A.IDKD_MCLS_CD_NM ORDER BY A.CNT DESC) AS KWRD_RANK
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_08_TEMP AS A
LEFT JOIN
(SELECT      IDKD_CD
      , IDKD_LCLS_CD
      , IDKD_MCLS_CD
      , IDKD_LCLS_CD_NM
      , IDKD_MCLS_CD_NM
     FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
     WHERE 1=1
      AND IDKD_SCLS_CD_NM = '전체') AS B
ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM
;


COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_09_TEMP ;
  
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_10_TEMP;
--TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_10_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_10_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_10_TEMP' AS 
SELECT
 'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '2' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.idkd_lcls_cd_nm
 , A.idkd_mcls_cd_nm
 , A.prod_kwrd
 , A.kwrd_cnt 
 , A.kwrd_rank
 , (B.KWRD_RANK-A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_09_TEMP AS A
 LEFT JOIN (
SELECT *
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '2'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
    ON A.IDKD_CD = B.IDKD_CD AND A.idkd_lcls_cd_nm = B.idkd_lcls_cd_nm AND A.idkd_mcls_cd_nm = B.idkd_mcls_cd_nm AND A.prod_kwrd = B.PROD_KWRD_NM
; 

 
COMPUTE STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_10_TEMP ;


--브랜드패션끝



/****************************************************************************************/
         -- 대분류시작
/****************************************************************************************/



/* 대분류 - 교육 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_1_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_1_TEMP' AS
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_4_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_4_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_4_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_1_TEMP;


--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_2_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_2_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_2_TEMP' AS
SELECT
  IDKD_LCLS_CD_NM
 , PROD_KWRD AS PROD_KWRD_NM
 , KWRD_CNT
 , RANK() OVER(PARTITION BY IDKD_LCLS_CD_NM ORDER BY KWRD_CNT DESC) AS KWRD_RANK
 , PROD_SUM_AMT
 , PROD_MAX_AMT
 , PROD_AVG_AMT
FROM ( SELECT
    IDKD_LCLS_CD_NM
   , PROD_KWRD
   , SUM(KWRD_CNT) AS KWRD_CNT
   , SUM(PROD_SUM_AMT) AS PROD_SUM_AMT
   , MAX(PROD_MAX_AMT) AS PROD_MAX_AMT
   , CASE WHEN SUM(PROD_SUM_AMT)/SUM(KWRD_CNT) IS NOT NULL THEN SUM(PROD_SUM_AMT)/SUM(KWRD_CNT)
     WHEN SUM(PROD_SUM_AMT)/SUM(KWRD_CNT) IS NULL THEN 0
     END AS PROD_AVG_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_1_TEMP
  GROUP BY IDKD_LCLS_CD_NM, PROD_KWRD ) AS A
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_2_TEMP;



--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_3_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_3_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_3_TEMP' AS   
SELECT
  B.IDKD_CD    -- 업종코드
 , B.IDKD_LCLS_CD --업종대분류코드
 , B.IDKD_MCLS_CD --업종중분류코드
 , A.IDKD_LCLS_CD_NM
 , '전체' AS IDKD_MCLS_CD_NM
 , A.PROD_KWRD_NM
 , A.KWRD_CNT 
 , A.KWRD_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_2_TEMP AS A
LEFT JOIN ( SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체'
    AND IDKD_MCLS_CD_NM = '전체' ) AS B
ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_3_TEMP;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_4_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_4_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_4_TEMP' AS   
SELECT
  'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '1' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.PROD_KWRD_NM
 , A.KWRD_CNT 
 , A.KWRD_RANK
-- , CAST(0 AS BIGINT) AS VAL_RANK
 , (B.KWRD_RANK - A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
-- , CAST(0 AS DOUBLE) AS KWRD_FLUC_RT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END  AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_3_TEMP AS A
LEFT JOIN ( SELECT
     IDKD_CD
    , IDKD_LCLS_CD_NM
    , IDKD_MCLS_CD_NM
    , PROD_KWRD_NM
    , KWRD_CNT
    , KWRD_RANK
    , KWRD_FLUC_RT
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
   AND P_BASIS_CLSS =  1
   AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
   AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '1'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
ON A.IDKD_CD = B.IDKD_CD AND A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.PROD_KWRD_NM = B.PROD_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_4_TEMP;


/* 대분류 - 식품 */
     
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_1_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_1_TEMP' AS
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_4_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_4_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_4_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_4_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_4_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_1_TEMP;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_2_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_2_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_2_TEMP' AS
SELECT
  IDKD_LCLS_CD_NM
 , PROD_KWRD AS PROD_KWRD_NM
 , KWRD_CNT
 , RANK() OVER(PARTITION BY IDKD_LCLS_CD_NM ORDER BY KWRD_CNT DESC) AS KWRD_RANK
 , PROD_SUM_AMT
 , PROD_MAX_AMT
 , PROD_AVG_AMT
FROM ( SELECT
    IDKD_LCLS_CD_NM
  -- , IDKD_MCLS_CD_NM
   , PROD_KWRD
   , SUM(KWRD_CNT) AS KWRD_CNT
   , SUM(PROD_SUM_AMT) AS PROD_SUM_AMT
   , MAX(PROD_MAX_AMT) AS PROD_MAX_AMT
   , CASE WHEN SUM(PROD_SUM_AMT)/SUM(KWRD_CNT) IS NOT NULL THEN SUM(PROD_SUM_AMT)/SUM(KWRD_CNT)
     WHEN SUM(PROD_SUM_AMT)/SUM(KWRD_CNT) IS NULL THEN 0
     END AS PROD_AVG_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_1_TEMP
  GROUP BY IDKD_LCLS_CD_NM, PROD_KWRD ) AS A
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_2_TEMP;



--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_3_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_3_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_3_TEMP' AS   
SELECT
  B.IDKD_CD    -- 업종코드
 , B.IDKD_LCLS_CD --업종대분류코드
 , B.IDKD_MCLS_CD --업종중분류코드
 , A.IDKD_LCLS_CD_NM
 , '전체' AS IDKD_MCLS_CD_NM
 , A.PROD_KWRD_NM
 , A.KWRD_CNT 
 , A.KWRD_RANK
-- , CAST(0 AS BIGINT) AS VAL_RANK
-- , (C.KWRD_RANK - A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
-- , CAST(0 AS DOUBLE) AS KWRD_FLUC_RT
-- , (A.KWRD_CNT - C.KWRD_CNT)/C.KWRD_CNT AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_2_TEMP AS A
LEFT JOIN ( SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체'
    AND IDKD_MCLS_CD_NM = '전체' ) AS B
ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM
;
COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_3_TEMP;


--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_4_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_4_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_4_TEMP' AS   
SELECT
  'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '1' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.PROD_KWRD_NM
 , A.KWRD_CNT 
 , A.KWRD_RANK
-- , CAST(0 AS BIGINT) AS VAL_RANK
 , (B.KWRD_RANK - A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
-- , CAST(0 AS DOUBLE) AS KWRD_FLUC_RT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END  AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_3_TEMP AS A
LEFT JOIN ( SELECT
     IDKD_CD
    , IDKD_LCLS_CD_NM
    , IDKD_MCLS_CD_NM
    , PROD_KWRD_NM
    , KWRD_CNT
    , KWRD_RANK
    , KWRD_FLUC_RT
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
    AND P_BASIS_CLSS =  1
    AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '1'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
ON A.IDKD_CD = B.IDKD_CD AND A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.PROD_KWRD_NM = B.PROD_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_4_TEMP;


/* 대분류 - 패션 */
--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_1_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_1_TEMP' AS
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_10_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_10_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_10_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_10_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_10_TEMP
UNION ALL
SELECT *
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_10_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_1_TEMP;


--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_2_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_2_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_2_TEMP' AS
SELECT
  IDKD_LCLS_CD_NM
 , PROD_KWRD AS PROD_KWRD_NM
 , KWRD_CNT
 , RANK() OVER(PARTITION BY IDKD_LCLS_CD_NM ORDER BY KWRD_CNT DESC) AS KWRD_RANK
 , PROD_SUM_AMT
 , PROD_MAX_AMT
 , PROD_AVG_AMT
FROM ( SELECT
    IDKD_LCLS_CD_NM
  -- , IDKD_MCLS_CD_NM
   , PROD_KWRD
   , SUM(KWRD_CNT) AS KWRD_CNT
   , SUM(PROD_SUM_AMT) AS PROD_SUM_AMT
   , MAX(PROD_MAX_AMT) AS PROD_MAX_AMT
   , CASE WHEN SUM(PROD_SUM_AMT)/SUM(KWRD_CNT) IS NOT NULL THEN SUM(PROD_SUM_AMT)/SUM(KWRD_CNT)
     WHEN SUM(PROD_SUM_AMT)/SUM(KWRD_CNT) IS NULL THEN 0
     END AS PROD_AVG_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_1_TEMP
  GROUP BY IDKD_LCLS_CD_NM, PROD_KWRD ) AS A
;


COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_2_TEMP;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_3_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_3_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_3_TEMP' AS   
SELECT
  B.IDKD_CD    -- 업종코드
 , B.IDKD_LCLS_CD --업종대분류코드
 , B.IDKD_MCLS_CD --업종중분류코드
 , A.IDKD_LCLS_CD_NM
 , '전체' AS IDKD_MCLS_CD_NM
 , A.PROD_KWRD_NM
 , A.KWRD_CNT 
 , A.KWRD_RANK
-- , CAST(0 AS BIGINT) AS VAL_RANK
-- , (C.KWRD_RANK - A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
-- , CAST(0 AS DOUBLE) AS KWRD_FLUC_RT
-- , (A.KWRD_CNT - C.KWRD_CNT)/C.KWRD_CNT AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_2_TEMP AS A
LEFT JOIN ( SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체'
    AND IDKD_MCLS_CD_NM = '전체' ) AS B
ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_3_TEMP;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_4_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_4_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_4_TEMP' AS   
SELECT
  'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '1' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.PROD_KWRD_NM
 , A.KWRD_CNT 
 , A.KWRD_RANK
-- , CAST(0 AS BIGINT) AS VAL_RANK
 , (B.KWRD_RANK - A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
-- , CAST(0 AS DOUBLE) AS KWRD_FLUC_RT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END  AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_3_TEMP AS A
LEFT JOIN ( SELECT
     IDKD_CD
    , IDKD_LCLS_CD_NM
    , IDKD_MCLS_CD_NM
    , PROD_KWRD_NM
    , KWRD_CNT
    , KWRD_RANK
    , KWRD_FLUC_RT
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
    AND P_BASIS_CLSS =  1
    AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '1'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
ON A.IDKD_CD = B.IDKD_CD AND A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.PROD_KWRD_NM = B.PROD_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_4_TEMP;


/************************************************************************************************************/

  --업종 전체 쿼리

/************************************************************************************************************/


/* 업종 전체 */


--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_1_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_1_TEMP' AS
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_09_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_09_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_09_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_09_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_09_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_09_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_4_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_4_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_4_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_4_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_4_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_4_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_4_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_4_TEMP
;


COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_1_TEMP;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_2_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_2_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_2_TEMP' AS
SELECT
  '전체' AS IDKD_LCLS_CD_NM
 , '전체' AS IDKD_MCLS_CD_NM
 , PROD_KWRD_NM 
 , KWRD_CNT
 , RANK() OVER(ORDER BY KWRD_CNT DESC) AS KWRD_RANK
 , PROD_SUM_AMT
 , PROD_MAX_AMT
 , PROD_AVG_AMT
FROM ( SELECT
--    IDKD_LCLS_CD_NM
  -- , IDKD_MCLS_CD_NM
    PROD_KWRD AS PROD_KWRD_NM
   , SUM(KWRD_CNT) AS KWRD_CNT
   , SUM(PROD_SUM_AMT) AS PROD_SUM_AMT
   , MAX(PROD_MAX_AMT) AS PROD_MAX_AMT
   , SUM(PROD_SUM_AMT)/SUM(KWRD_CNT) AS PROD_AVG_AMT
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_1_TEMP
  GROUP BY PROD_KWRD ) AS A
;


COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_2_TEMP;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_3_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_3_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_3_TEMP' AS   
SELECT
  B.IDKD_CD    -- 업종코드
 , B.IDKD_LCLS_CD --업종대분류코드
 , B.IDKD_MCLS_CD --업종중분류코드
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.PROD_KWRD_NM
 , A.KWRD_CNT 
 , A.KWRD_RANK
-- , CAST(0 AS BIGINT) AS VAL_RANK
-- , (C.KWRD_RANK - A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
-- , CAST(0 AS DOUBLE) AS KWRD_FLUC_RT
-- , (A.KWRD_CNT - C.KWRD_CNT)/C.KWRD_CNT AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_2_TEMP AS A
LEFT JOIN ( SELECT *
   FROM BDPL200.L2CET_IDKD_CLSS_CD_LIST
   WHERE 1=1
    AND IDKD_SCLS_CD_NM = '전체'
    AND IDKD_MCLS_CD_NM = '전체'
    AND IDKD_LCLS_CD_NM = '전체' ) AS B
ON A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_3_TEMP;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_4_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_4_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_4_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_4_TEMP' AS   
SELECT
  'MDIA_SCRN_01' AS SCRN_DIVS_CD
 , 'D' AS TERM_CLSS_CD
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy') AS TERM_YY
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM') AS TERM_MM
 , FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-1)), 'yyyy-MM-dd') AS TERM_DT_NM
 , '0' AS IDKD_CLSS_LVL_CD
 , A.IDKD_CD    -- 업종코드
 , A.IDKD_LCLS_CD --업종대분류코드
 , A.IDKD_MCLS_CD --업종중분류코드
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.PROD_KWRD_NM
 , A.KWRD_CNT 
 , A.KWRD_RANK
-- , CAST(0 AS BIGINT) AS VAL_RANK
 , (B.KWRD_RANK - A.KWRD_RANK) AS VAL_RANK
 , A.PROD_SUM_AMT
 , A.PROD_MAX_AMT
 , A.PROD_AVG_AMT
-- , CAST(0 AS DOUBLE) AS KWRD_FLUC_RT
 , CASE WHEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT <= 10000000000 AND (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT >= -10000000000 THEN (A.KWRD_CNT - B.KWRD_CNT)/B.KWRD_CNT ELSE NULL END  AS KWRD_FLUC_RT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_3_TEMP AS A
LEFT JOIN ( SELECT
     IDKD_CD
    , IDKD_LCLS_CD_NM
    , IDKD_MCLS_CD_NM
    , PROD_KWRD_NM
    , KWRD_CNT
    , KWRD_RANK
    , KWRD_FLUC_RT
   FROM BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD
   WHERE 1=1
    AND P_BASIS_CLSS =  1
    AND P_BASIS_YYYY = YEAR( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND P_BASIS_MM = MONTH( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND P_BASIS_DD = DAY( DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2))
    AND SCRN_DIVS_CD = 'MDIA_SCRN_01'
    AND TERM_CLSS_CD = 'D'
    AND IDKD_CLSS_LVL_CD = '0'
    AND TRANSLATE(SUBSTR(TERM_DT_NM, 1, 10), '-', '') = FROM_UNIXTIME(UNIX_TIMESTAMP(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP),-2)), 'yyyyMMdd')  ) AS B
ON A.IDKD_CD = B.IDKD_CD AND A.IDKD_LCLS_CD_NM = B.IDKD_LCLS_CD_NM AND A.IDKD_MCLS_CD_NM = B.IDKD_MCLS_CD_NM AND A.PROD_KWRD_NM = B.PROD_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_4_TEMP;


--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_1_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_ALL_1_TEMP' AS
SELECT
  scrn_divs_cd
 , term_clss_cd
 , term_yy
 , term_mm
 , term_dt_nm
 , idkd_clss_lvl_cd
 , idkd_cd
 , idkd_lcls_cd
 , idkd_mcls_cd
 , idkd_lcls_cd_nm
 , idkd_mcls_cd_nm
 , prod_kwrd
 , kwrd_cnt
 , kwrd_rank
 , VAL_RANK
 , prod_sum_amt 
 , prod_max_amt
 , PROD_AVG_AMT
 , kwrd_fluc_rt
FROM (
  SELECT
    *
   , ROW_NUMBER() OVER(PARTITION BY IDKD_CLSS_LVL_CD, IDKD_CD, IDKD_LCLS_CD, IDKD_MCLS_CD ORDER BY KWRD_RANK, PROD_SUM_AMT, PROD_AVG_AMT, PROD_MAX_AMT, prod_kwrd) AS AAA
  FROM (
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_10_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_10_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_10_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_10_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_10_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_10_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_5_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_5_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_5_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_5_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_5_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_5_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_5_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_5_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LRG_4_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_LRG_4_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_LRG_4_TEMP UNION ALL
SELECT * FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_IDKD_4_TEMP
   ) TMP
  ) TMP2
WHERE 1=1
 AND AAA <= 2000
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_1_TEMP;



/**********************************************************************/
  --화면 2 - 상품상세명 생성
/**********************************************************************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_0_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_0_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_0_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_NAME_0_TEMP' AS 
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , STYLE_SHAPE_KWRD AS PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_ACC_SHAPE_STYLE_FIND_07_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , STYLE_SHAPE_KWRD AS PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPECIAL_SHAPE_STYLE_FIND_07_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , STYLE_SHAPE_KWRD AS PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_SPORTS_SHAPE_STYLE_FIND_07_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , STYLE_SHAPE_KWRD AS PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_WOMEN_SHAPE_STYLE_FIND_07_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , STYLE_SHAPE_KWRD AS PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_MEN_SHAPE_STYLE_FIND_07_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , STYLE_SHAPE_KWRD AS PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FASHION_BRAND_SHAPE_STYLE_FIND_07_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_COOK_2_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_SNACK_2_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_AGR_2_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_HLTH_2_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_FOOD_TOTAL_2_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_LANG_2_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SPECIAL_2_TEMP UNION ALL
SELECT IDKD_LCLS_CD_NM , IDKD_MCLS_CD_NM, STORE_NM , ELST_SVC_NM , TRX_ID, STLM_AMT , PROD_KWRD FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_EDU_SCHOOL_2_TEMP
;


COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_0_TEMP;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_1_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_1_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_1_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_NAME_1_TEMP' AS 
SELECT
  PROD_KWRD AS PROD_KWRD_NM
 , ELST_SVC_NM
 , COUNT(TRX_ID) AS CNT
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_0_TEMP
GROUP BY PROD_KWRD, ELST_SVC_NM
ORDER BY PROD_KWRD, CNT DESC
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_1_TEMP;

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_2_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_2_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_2_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_NAME_2_TEMP' AS 
SELECT
  PROD_KWRD_NM
 , ELST_SVC_NM
FROM ( SELECT
    PROD_KWRD_NM
   , ELST_SVC_NM
   , ROW_NUMBER() OVER(PARTITION BY PROD_KWRD_NM ORDER BY CNT DESC, ELST_SVC_NM) AS RANKING
  FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_1_TEMP ) TMP
WHERE 1=1
 AND RANKING <= 5
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_2_TEMP;


--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_3_TEMP;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_3_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_3_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_NAME_3_TEMP' AS 
SELECT
  'MDIA_SCRN_02' AS SCRN_DIVS_CD
 , A.TERM_CLSS_CD
 , A.TERM_YY
 , A.TERM_MM
 , A.TERM_DT_NM
 , A.IDKD_CLSS_LVL_CD
 , A.IDKD_CD
 , A.IDKD_LCLS_CD
 , A.IDKD_MCLS_CD
 , A.IDKD_LCLS_CD_NM
 , A.IDKD_MCLS_CD_NM
 , A.PROD_KWRD AS PROD_KWRD_NM
 , B.ELST_SVC_NM AS PROD_DETL_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_1_TEMP AS A
LEFT JOIN BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_2_TEMP AS B
ON A.PROD_KWRD = B.PROD_KWRD_NM
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_3_TEMP;



/*****************************************************************************/

    --최종테이블로 UNION ALL

/*****************************************************************************/

--DROP TABLE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_TEMP ;
------TRUNCATE IF EXISTS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_TEMP;
INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_TEMP --STORED AS PARQUET
--LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_RANK_1D_ALL_TEMP' AS
SELECT
  SCRN_DIVS_CD
 , TERM_CLSS_CD
 , TERM_YY
 , TERM_MM
 , TERM_DT_NM
 , IDKD_CLSS_LVL_CD
 , IDKD_CD
 , IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , PROD_KWRD AS PROD_KWRD_NM
 , KWRD_CNT
 , KWRD_RANK
 , VAL_RANK AS KWRD_VRBL_RANK
 , PROD_SUM_AMT
 , PROD_MAX_AMT
 , PROD_AVG_AMT AS PROD_AVR_AMT
 , KWRD_FLUC_RT
 , NULL AS PROD_DETL_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_1_TEMP
UNION ALL
SELECT
  SCRN_DIVS_CD
 , TERM_CLSS_CD
 , TERM_YY
 , TERM_MM
 , TERM_DT_NM
 , IDKD_CLSS_LVL_CD
 , IDKD_CD
 , IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , PROD_KWRD_NM
 , NULL AS KWRD_CNT
 , NULL AS KWRD_RANK
 , NULL AS KWRD_VRBL_RANK
 , NULL AS PROD_SUM_AMT
 , NULL AS PROD_MAX_AMT
 , NULL AS PROD_AVR_AMT
 , NULL AS KWRD_FLUC_RT
 , PROD_DETL_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_NAME_3_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_TEMP;








INSERT OVERWRITE TABLE BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD ----STORED AS PARQUET
----LOCATION '/BDP/impala_table/L2/00/L2COT_IDKD_POP_PROD_KWRD_RANK_SECD' AS
PARTITION (
   P_BASIS_YYYY = YEAR(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)),
   P_BASIS_MM = MONTH(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)),
   P_BASIS_DD =  day(DAYS_ADD(CAST('${VAR:C_YYYYMMDD} ${VAR:C_HHMISS}' AS TIMESTAMP), -1)),
   P_BASIS_CLSS =  1
    )
SELECT
  SCRN_DIVS_CD
 , TERM_CLSS_CD
 , TERM_YY
 , TERM_MM
 , TERM_DT_NM
 , IDKD_CLSS_LVL_CD
 , IDKD_CD
 , IDKD_LCLS_CD
 , IDKD_MCLS_CD
 , IDKD_LCLS_CD_NM
 , IDKD_MCLS_CD_NM
 , PROD_KWRD_NM
 , KWRD_CNT
 , KWRD_RANK
 , KWRD_VRBL_RANK
 , CAST(PROD_SUM_AMT AS DECIMAL(38,2)) AS PROD_SUM_AMT
 , CAST(PROD_MAX_AMT AS DECIMAL(15,2)) AS PROD_MAX_AMT
 , CAST(PROD_AVR_AMT AS DECIMAL(38,2)) AS PROD_AVR_AMT
 , CAST(KWRD_FLUC_RT AS DECIMAL(10,6)) AS KWRD_FLUC_RT
 , PROD_DETL_NM
FROM BDPL200.L2COT_IDKD_POP_PROD_RANK_1D_ALL_TEMP
;

COMPUTE INCREMENTAL STATS BDPL200.L2COT_IDKD_POP_PROD_KWRD_RANK_SECD;
